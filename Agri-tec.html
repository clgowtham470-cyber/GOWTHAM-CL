
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOCAL FOOD MARKET PLACE </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <!-- inert polyfill for better overlay accessibility -->
    <script src="https://unpkg.com/wicg-inert@3.1.1/dist/inert.min.js"></script>
    <!-- Leaflet for map interface -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'dark-bg': '#0a0a0a',
                        'dark-surface': '#1a1a1a',
                        'intimidating-red': '#8b0000',
                        'electric-blue': '#0066ff',
                        'metallic-gray': '#2a2a2a',
                        'glow-blue': '#00a8ff'
                    },
                    animation: {
                        'pulse-glow': 'pulse-glow 2s ease-in-out infinite alternate',
                        'scan-line': 'scan-line 3s linear infinite'
                    },
                    keyframes: {
                        'pulse-glow': {
                            '0%': { 'box-shadow': '0 0 5px #0066ff, 0 0 10px #0066ff, 0 0 15px #0066ff' },
                            '100%': { 'box-shadow': '0 0 10px #00a8ff, 0 0 20px #00a8ff, 0 0 30px #00a8ff' }
                        },
                        'scan-line': {
                            '0%': { 'transform': 'translateY(-100%)' },
                            '100%': { 'transform': 'translateY(100vh)' }
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Global Styles */
        :root {
            --text-color: #333;
            --bg-color: #fff;
            --card-bg: #f1f3f6;
        }
        .dark-mode {
            --text-color: #fff;
            --bg-color: #1a1a1a;
            --card-bg: #2c3e50;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 50%, #000000 100%);
            position: relative;
            overflow-x: hidden;
            overflow-y: scroll;
            color: var(--text-color, #333);
        }
        /* Home screen specific background */
        #home {
            transition: box-shadow 0.15s;
        }


        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(circle at 20% 80%, rgba(139, 0, 0, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(0, 102, 255, 0.1) 0%, transparent 50%),
                linear-gradient(45deg, transparent 48%, rgba(0, 168, 255, 0.05) 50%, transparent 52%);
            background-size: 200% 200%, 200% 200%, 50px 50px;
            animation: background-shift 10s ease-in-out infinite;
            pointer-events: none;
        }

        @keyframes background-shift {
            0%, 100% { background-position: 0% 0%, 100% 100%, 0 0; }
            50% { background-position: 100% 100%, 0% 0%, 50px 50px; }
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        /* Header */
        header {
            background-color: #2c3e50;
            color: white;
            padding: 1rem 0;
        }
        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            background: linear-gradient(45deg, #8b4513, #228b22, #daa520);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .nav-links {
            display: flex;
            list-style: none;
        }
        .nav-links li {
            margin-left: 20px;
        }
        .nav-links a {
            color: white;
            text-decoration: none;
        }
        .search-bar {
            display: flex;
            margin: 10px 0;
        }
        .search-bar input {
            flex: 1;
            padding: 10px;
            border: 2px solid #27ae60;
            border-radius: 9px 0 0 9px;
            animation: leafBorder 0.4s infinite;
        }
        .search-bar button {
            padding: 10px 20px;
            background-color: #18b8d4;
            color: rgb(15, 133, 211);
            border: none;
            border-radius: 0 4px 4px 0;
            cursor: pointer;
        }
        /* Main Content */
        main {
            padding: 20px 0;
        }
        .hero {
            position: relative;
            overflow: hidden;
            background: linear-gradient(135deg, #f5f5dc 0%, #ffe4e1 50%, #f5f5dc 100%);
            color: #8b4513;
            text-align: center;
            padding: 50px 0;
            margin-bottom: 30px;
        }
        .hero::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 20% 30%, rgba(255, 228, 225, 0.5) 0%, transparent 50%),
                        radial-gradient(circle at 80% 70%, rgba(245, 245, 220, 0.5) 0%, transparent 50%),
                        radial-gradient(circle at 50% 50%, rgba(255, 228, 225, 0.4) 0%, transparent 50%);
            filter: blur(20px);
            z-index: -1;
        }
        .hero h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        .hero p {
            font-size: 1.2rem;
        }
        .categories {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .category {
            background-color: white;
            padding: 20px;
            text-align: center;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.3s;
        }
        .category:hover {
            transform: translateY(-5px);
        }
        .products {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        .product {
            background-color: #f1f3f6;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgb(80, 77, 77);
            transition: transform 0.3s;
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
        }
        .product:hover {
            transform: translateY(-5px);
        }
        .product img {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }
        .product-info {
            padding: 15px;
            color: var(--text-color);
        }
        .product h3 {
            margin-bottom: 10px;
            color: var(--text-color);
        }
        .product p {
            margin-bottom: 10px;
            color: var(--text-color);
        }
        .price {
            font-weight: bold;
            color: #27ae60;
        }
        .farmer-profile {
            background: white;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        /* Typography and utilities */
        html { font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        h1, h2, h3, h4 { color: var(--text-color); margin-bottom: 12px; }
        p { line-height: 1.5; }
        .muted { color: #6b7280; font-size: 0.95rem; }

        /* Responsive header / nav */
        nav .nav-left { display:flex; align-items:center; gap:12px; }
        .nav-right { display:flex; align-items:center; gap:12px; }
        .nav-links { gap: 16px; display:flex; align-items:center; }
        #mobile-menu-toggle { display: none; background: transparent; border: none; color: white; font-size: 1.2rem; }
        @media (max-width: 800px) {
            nav { flex-direction: column; align-items: stretch; gap: 10px; }
            /* Animated mobile menu: collapsed by default */
            .nav-links { flex-direction: column; width: 100%; max-height: 0; overflow: hidden; opacity: 0; transition: max-height 260ms ease, opacity 220ms ease; pointer-events: none; }
            /* When open, allow it to expand */
            .nav-links.mobile-open { max-height: 520px; opacity: 1; pointer-events: auto; }
            #mobile-menu-toggle { display: inline-flex; }
            .logo { font-size: 1.25rem; }
            .product { flex-direction: column; }
            .product img { height: 180px; }
            .cart { width: 100%; right: -100%; }
            .cart.open { right: 0; }
            .pay-now-btn { padding: 12px; }
        }

        /* Product card improvements */
        .product { align-items: flex-start; }
        .product-info { flex: 1 1 auto; }
        .product .product-images, .product img { border-radius: 6px; overflow: hidden; }
        .product-info .btn { margin-right: 8px; margin-top: 8px; }
        /* Enhanced mobile product card */
        @media (max-width: 768px) {
            .product {
                flex-direction: column;
                text-align: center;
            }
            .product img {
                width: 100%;
                height: auto;
                max-height: 200px;
            }
            .product-info .btn {
                width: 100%;
                margin: 5px 0;
            }
        }

        /* Form inputs */
        input[type="text"], input[type="email"], input[type="tel"], input[type="password"], select, textarea {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid #d1d5db;
            border-radius: 10px;
            background: #fff;
            color: var(--text-color);
            transition: border-color 150ms ease, box-shadow 150ms ease;
            font-size: 16px; /* Prevent zoom on mobile */
        }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #0b6bff; box-shadow: 0 4px 18px rgba(11,107,255,0.08); }
        /* Enhanced form layouts for mobile */
        @media (max-width: 768px) {
            .form-container {
                padding: 25px 15px;
                margin: 10px;
            }
            .form-group {
                margin-bottom: 25px;
            }
            .btn {
                padding: 12px 20px;
                font-size: 16px;
            }
        }

        /* Footer styling */
        footer { background: linear-gradient(90deg, rgba(44,62,80,1) 0%, rgba(31,38,44,1) 100%); color: #cbd5e1; padding: 24px 0; text-align: center; }
        footer p { margin-bottom: 6px; }
        footer .small { font-size: 0.9rem; color: #94a3b8; }

        /* Utility helpers */
        .grid-2 { display: grid; grid-template-columns: 1fr 320px; gap: 20px; }
        @media (max-width: 1000px) { .grid-2 { grid-template-columns: 1fr; } }

    /* Helper classes to avoid inline styles */
    .hidden { display: none !important; }
    .input-row { display: flex; align-items: center; gap: 10px; }
    .order-item-img { width: 50px; height: 50px; object-fit: cover; }
    .otp-display { display: none; color: green; font-weight: bold; }

        /* Accessibility focus improvements */
        :focus { outline: none; }
        :focus-visible { box-shadow: 0 0 0 4px rgba(11,107,255,0.12); }
.btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 10px 18px;
    color: #fff;
    background-color: #1f8a4d; /* primary green */
    border: 1px solid rgba(0,0,0,0.05);
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    font-size: 15px;
    line-height: 1;
    transition: box-shadow 200ms ease, transform 120ms ease, background-color 150ms ease;
    box-shadow: 0 4px 12px rgba(31,138,77,0.12);
    text-decoration: none;
}
.btn:hover {
    background-color: #19743f;
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(25,116,63,0.12);
}
.btn:active { transform: translateY(0); }
.btn:focus { outline: none; }
.btn:focus-visible { box-shadow: 0 0 0 4px rgba(31,138,77,0.18); }
.btn i { margin-right: 8px; }

.btn-block {
    width: 100%;
    margin: 10px 0;
    display: block;
}

.btn-secondary {
    background-color: #2f3a44;
    color: #000;
    box-shadow: 0 4px 12px rgba(47,58,68,0.08);
}
.btn-secondary:hover { background-color: #25303a; transform: translateY(-2px); }
.btn-secondary:focus-visible { box-shadow: 0 0 0 4px rgba(47,58,68,0.12); }

.btn-ghost {
    background: transparent;
    color: #1f8a4d;
    border: 1px solid rgba(31,138,77,0.12);
}
.btn-ghost:hover { background: rgba(31,138,77,0.04); }

.btn-danger {
    background-color: #c0392b;
    color: #fff;
}
.btn-danger:hover { background-color: #a33226; }
.btn-danger:focus-visible { box-shadow: 0 0 0 4px rgba(192,57,43,0.12); }

/* Pay now - prominent */
.pay-now-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    padding: 14px 20px;
    background-color: #0b6bff;
    color: #fff;
    border-radius: 10px;
    border: none;
    font-size: 16px;
    font-weight: 700;
    box-shadow: 0 10px 30px rgba(11,107,255,0.15);
}
.pay-now-btn:hover { background-color: #095ee6; transform: translateY(-2px); }
.pay-now-btn:focus-visible { box-shadow: 0 0 0 5px rgba(11,107,255,0.12); }

/* Smaller variant */
.btn.small { padding: 8px 12px; font-size: 13px; border-radius: 6px; }

/* Cancel button consistent style */
.cancel-btn {
    background-color: #c0392b;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
}
.cancel-btn:hover { background-color: #a33226; }
        /* Cart */
        .cart {
            position: fixed;
            top: 0;
            right: -300px;
            width: 300px;
            height: 100%;
            background-color: white;
            box-shadow: -2px 0 5px rgba(0,0,0,0.1);
            transition: right 0.3s;
            z-index: 1000;
            overflow-y: auto;
        }
        .cart.open {
            right: 0;
        }
        .cart-header {
            background-color: #2c3e50;
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .cart-items {
            padding: 20px;
        }
        .cart-item {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
        }
        .cart-item img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            margin-right: 10px;
        }
        .cart-item-info h4 {
            margin-bottom: 5px;
        }
        .cart-total {
            padding: 20px;
            border-top: 1px solid #eee;
            font-weight: bold;
        }
        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }
        .quantity-controls button {
            padding: 5px 10px;
            background-color: #3498db;
            color: white;
            border: none;
            cursor: pointer;
        }
        .quantity-controls span {
            font-weight: bold;
        }
        /* Forms */
        .form-container {
            max-width: 400px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
        }
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        /* Product Detail */
        .product-detail {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        #product-detail-content h1,
        #product-detail-content p,
        #product-detail-content h2,
        #product-detail-content h4,
        #product-detail-content .review p {
            color: var(--text-color);
        }
        .product-images {
            display: flex;
            flex-direction: column;
        }
        .product-images img {
            width: 100%;
            margin-bottom: 10px;
        }
        .reviews {
            margin-top: 20px;
        }
        .review {
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
            margin-bottom: 15px;
        }
        /* Filters */
        .filters {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .filters h3 {
            margin-bottom: 15px;
        }
        .filter-group {
            margin-bottom: 15px;
        }
        .filter-group label {
            display: block;
            margin-bottom: 5px;
        }
        .filter-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        /* Checkout */
        .checkout-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        .order-summary {
            background: linear-gradient(135deg, #fefefe 0%, #f9f6f0 100%);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(139, 69, 19, 0.1);
            border: 1px solid #e8dcc0;
        }
        .payment-options {
            margin-top: 20px;
        }
        .payment-option {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }
        .payment-option:hover {
            border-color: #3498db;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.2);
        }
        .payment-option.selected {
            border-color: #27ae60;
            background: #f0f9f0;
        }
        .payment-option input[type="radio"] {
            margin-right: 15px;
        }
        /* Loading spinner */
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Dark mode styles */
        .dark-mode {
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 50%, #000000 100%);
            color: white;
        }
        .dark-mode .hero {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 50%, #2c3e50 100%);
        }
        .dark-mode .product, .dark-mode .category, .dark-mode .filters {
            background-color: #2c3e50;
            color: white;
        }
        .dark-mode .cart {
            background-color: #2c3e50;
        }
        .dark-mode .form-container {
            background-color: #2c3e50;
            color: white;
        }
        .dark-mode .order-summary {
            background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
        }
        .dark-mode .detail-card {
            background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
        }
        .dark-mode .order {
            background-color: #34495e;
        }
        /* Ensure buttons are visible in dark mode */
        .dark-mode .btn {
            border: 2px solid #fff;
            box-shadow: 0 4px 12px rgba(255,255,255,0.2);
        }
        .dark-mode .btn-secondary {
            background-color: #fff;
            color: #000;
            border: 2px solid #fff;
        }
        .dark-mode .btn-secondary:hover {
            background-color: #f0f0f0;
        }
        .dark-mode .pay-now-btn {
            border: 2px solid #fff;
        }
        .dark-mode .cancel-btn {
            background-color: #fff;
            color: #000;
            border: 2px solid #fff;
        }
        .dark-mode .cancel-btn:hover {
            background-color: #f0f0f0;
        }
        .payment-icon {
            margin-right: 15px;
            font-size: 24px;
            color: #3498db;
        }
        .payment-details {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 8px;
        }
        .upi-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        .upi-option {
            display: flex;
            align-items: center;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .upi-option:hover {
            background: #f0f0f0;
        }
        .upi-option.selected {
            background: #e8f5e8;
            border-color: #27ae60;
        }
        .upi-option img {
            width: 30px;
            height: 30px;
            margin-right: 8px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .security-message {
            margin-top: 20px;
            padding: 10px;
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            color: #856404;
            font-size: 14px;
        }
        .order-breakdown {
            margin-top: 20px;
        }
        .breakdown-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        .grand-total {
            border-top: 2px solid #ddd;
            padding-top: 10px;
            font-weight: bold;
            font-size: 18px;
        }
        .pay-now-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .pay-now-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
        }
        .confirmation-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
        .modal-content h2 {
            color: #27ae60;
            margin-bottom: 20px;
        }
        .modal-content p {
            margin-bottom: 20px;
        }
        .modal-content button {
            padding: 10px 20px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        /* Profile */
        .profile-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .profile-header {
            text-align: center;
            margin-bottom: 30px;
        }
        .profile-photo {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            border: 5px solid #f4e4bc;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin: 0 auto 20px;
            display: block;
        }
        .profile-name {
            font-size: 2rem;
            color: #8b4513;
            margin-bottom: 10px;
        }
        .profile-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .detail-card {
            background: linear-gradient(135deg, #fefefe 0%, #f9f6f0 100%);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(139, 69, 19, 0.1);
            border: 1px solid #e8dcc0;
        }
        .detail-card h3 {
            color: #a0522d;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }
        .detail-item {
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .detail-label {
            font-weight: bold;
            color: #8b4513;
        }
        .detail-value {
            color: #654321;
        }
        .order-history {
            background: linear-gradient(135deg, #fefefe 0%, #f9f6f0 100%);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(139, 69, 19, 0.1);
            border: 1px solid #e8dcc0;
        }
        .order-history h3 {
            color: #a0522d;
            margin-bottom: 20px;
        }
        .order {
            background-color: #faf8f2;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .order-info {
            flex: 1;
        }
        .cancel-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .cancel-btn:hover {
            background-color: #c0392b;
        }
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        .modal h3 {
            margin-bottom: 20px;
            color: #a0522d;
        }
        .modal select {
            width: 100%;
            padding: 10px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .modal-buttons {
            display: flex;
            justify-content: space-between;
        }
        .modal-buttons button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .confirm-cancel {
            background-color: #e74c3c;
            color: white;
        }
        .confirm-cancel:hover {
            background-color: #c0392b;
        }
        .cancel-modal {
            background-color: #95a5a6;
            color: white;
        }
        .cancel-modal:hover {
            background-color: #7f8c8d;
        }
        /* Footer */
        footer {
            background-color: #2c3e50;
            color: white;
            text-align: center;
            padding: 20px 0;
            margin-top: 50px;
        }
        footer p {
            background: linear-gradient(45deg, #8b4513, #228b22, #daa520);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        /* Responsive */
@media (max-width: 768px) {
    nav {
        flex-direction: column;
    }
    .nav-links {
        margin-top: 10px;
    }
    .product-detail {
        grid-template-columns: 1fr;
    }
    .checkout-form {
        grid-template-columns: 1fr;
    }
}
@media (min-width: 768px) {
    .container {
        max-width: 1000px;
    }
    .hero h1 {
        font-size: 3rem;
    }
    .products {
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    }
}
@media (min-width: 1024px) {
    .container {
        max-width: 1200px;
    }
    .hero h1 {
        font-size: 3.5rem;
    }
    .categories {
        grid-template-columns: repeat(4, 1fr);
    }
    .products {
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    }
}
@media (max-width: 480px) {
    .hero h1 {
        font-size: 1.8rem;
    }
    .hero p {
        font-size: 1rem;
    }
    .categories {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    }
    .products {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    }
    .product img {
        height: 150px;
    }
    .form-container {
        padding: 20px;
    }
    .profile-photo {
        width: 120px;
        height: 120px;
    }
}
        /* Accessibility */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        /* Additional ARIA labels
           NOTE: aria-label attributes cannot be set via CSS. They must be present on the HTML elements
           or added via JavaScript. The invalid CSS rules were removed to fix the syntax errors.
        */
        /* Hide sections initially */
        .page {
            display: none;
            opacity: 0;
            animation: fadeIn 0.5s ease-in-out forwards;
        }
        .page.active {
            display: block;
        }
        @keyframes fadeIn {
            to { opacity: 1; }
        }

        /* 3D Glowing Animation for Home Screen */
        #home .logo {
            transform-style: preserve-3d;
        }

        #home .nav-links a {
            transform-style: preserve-3d;
            display: inline-block;
        }

        @keyframes leafBorder {
            0%, 100% {
                border-color: #27ae60;
            }
            50% {
                border-color: #2ecc71;
            }
        }

        .leaf {
            position: absolute;
            top: -10px;
            width: 50px;
            height: 30px;
            background: #86a10b;
            clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
            animation: leafFall 10s linear infinite;
            pointer-events: none;
            z-index: -1;
        }

        @keyframes leafFall {
            0% {
                transform: translateY(-100vh) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }

        /* Home cart section text color */
        #home-cart-section h2 {
            color: white;
        }
        #home-cart-items .cart-item-info h4,
        #home-cart-items .cart-item-info p {
            color: white;
        }
        #home-cart-total {
            color: white;
        }
        #home-cart-items p {
            color: var(--text-color);
        }

        /* Products page heading text color */
        #products h1 {
            color: white;
        }

        /* Wishlist page text color */
        #wishlist h1 {
            color: white;
        }
        #wishlist-items p {
            color: white;
        }

        /* Inventory page text color */
        #inventory h1 {
            color: white;
        }

        /* Profile page button text color */
        #edit-profile-btn,
        #logout-btn {
            color: white;
        }

        /* Order history styles */
        .order-items {
            margin-top: 10px;
        }
        .order-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .order-item img {
            margin-right: 10px;
        }
        .order-item-details h5 {
            margin: 0 0 5px 0;
        }
        .order-item-details p {
            margin: 2px 0;
        }

        /* Checkout text color changes */
        #checkout h1,
        #checkout h3,
        #checkout label {
            color: white;
        }

        /* Calendar styles */
        .calendar {
            border-collapse: collapse;
            width: 100%;
            margin-top: 10px;
        }
        .calendar th, .calendar td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
            color: white;
        }
        .calendar-day:hover {
            background: #f0f0f0;
            cursor: pointer;
        }
        .calendar-day.selected {
            background: #27ae60;
            color: white;
            animation: pulse-glow 2s ease-in-out infinite alternate;
        }
        .calendar-day.available {
            background: #27ae60;
            color: white;
        }
        .calendar-day.unavailable {
            background: #e74c3c;
            color: white;
        }
        .calendar-day.disabled {
            background: #95a5a6;
            color: #666;
            cursor: not-allowed;
        }


    </style>
</head>
<body>
    <div class="leaf" style="left: 10%; animation-delay: 0s;"></div>
    <div class="leaf" style="left: 20%; animation-delay: 2s;"></div>
    <div class="leaf" style="left: 30%; animation-delay: 4s;"></div>
    <div class="leaf" style="left: 40%; animation-delay: 6s;"></div>
    <div class="leaf" style="left: 50%; animation-delay: 8s;"></div>
    <div class="leaf" style="left: 60%; animation-delay: 1s;"></div>
    <div class="leaf" style="left: 70%; animation-delay: 3s;"></div>
    <div class="leaf" style="left: 80%; animation-delay: 5s;"></div>
    <div class="leaf" style="left: 90%; animation-delay: 7s;"></div>
    <div class="leaf" style="left: 15%; animation-delay: 9s;"></div>
    <div class="leaf" style="left: 10%; animation-delay: 0.5s;"></div>
    <div class="leaf" style="left: 20%; animation-delay: 2.5s;"></div>
    <div class="leaf" style="left: 30%; animation-delay: 4.5s;"></div>
    <div class="leaf" style="left: 40%; animation-delay: 6.5s;"></div>
    <div class="leaf" style="left: 50%; animation-delay: 8.5s;"></div>
    <div class="leaf" style="left: 60%; animation-delay: 1.5s;"></div>
    <div class="leaf" style="left: 70%; animation-delay: 3.5s;"></div>
    <div class="leaf" style="left: 80%; animation-delay: 5.5s;"></div>
    <div class="leaf" style="left: 90%; animation-delay: 7.5s;"></div>
    <div class="leaf" style="left: 15%; animation-delay: 9.5s;"></div>
    <!-- Header -->
    <header>
        <nav class="container">
            <div class="nav-left">
                <div class="logo">LOCAL FOOD MARKET PLACE </div>
                <button id="mobile-menu-toggle" type="button" aria-label="Toggle menu" onclick="toggleMobileMenu()">☰</button>
            </div>
            <div class="nav-right">
                <ul class="nav-links" id="nav-links">
                    <li><a href="#" onclick="showPage('home'); return false;">Home</a></li>
                    <li><a href="#" onclick="showPage('products'); return false;">Products <i class="fas fa-plus"></i></a></li>
    <li><a href="#" id="cart-toggle" role="button" aria-controls="cart" aria-expanded="false" onclick="toggleCart(); return false;" aria-label="View shopping cart">Cart (<span id="cart-count">0</span>)</a></li>
    <li><a href="#" onclick="showPage('wishlist'); return false;">Wishlist</a></li>
    <li><a href="#" onclick="showPage('farmers'); return false;">Farmers</a></li>
    <li><a href="#" onclick="showPage('inventory'); return false;">Inventory</a></li>

    <li><a href="#" onclick="showPage('profile'); return false;">login</a></li>
</ul>
                <button id="dark-mode-toggle" type="button" aria-label="Toggle dark mode">🌙</button>
            </div>
        </nav>
        <div class="container">
            <div class="search-bar">
                <input type="text" id="search-input" placeholder="Search products." oninput="searchProducts()" aria-label="Search for products">
                <button type="button" onclick="searchProducts()" aria-label="Search for products">Search</button>
            </div>
            <div id="user-info"></div>
            <div id="login-message" aria-live="polite" style="margin-top:8px;color:#27ae60;"></div>
        </div>
    </header>

    <!-- Cart Sidebar -->
    <div class="cart" id="cart" role="region" aria-label="Shopping cart" tabindex="-1">
            <div class="cart-header">
            <h2>Shopping Cart</h2>
            <button type="button" onclick="toggleCart()" aria-label="Close cart">×</button>
        </div>
        <div class="cart-items" id="cart-items">
            <!-- Cart items will be populated here -->
        </div>
        <div class="cart-total" id="cart-total">
            Total: ₹0.00
        </div>
    <button type="button" class="btn btn-secondary btn-block" onclick="toggleCart()" aria-label="Continue shopping">Continue Shopping</button>
    <button type="button" class="btn btn-block" onclick="showPage('checkout')" aria-label="Proceed to checkout">Checkout</button>
    </div>

    <!-- Main Content -->
    <main class="container">
        <!-- Home Page -->
        <div id="home" class="page active">
            <section class="hero">
                <h1>Welcome to Market place</h1>
                <p>Your trusted source for high-quality products from Farmers</p>
    <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
        <button type="button" class="btn" onclick="showPage('products')" aria-label="Shop now for products">Shop Now</button>
    </div>
            </section>

            <section class="categories">
                <div class="category" onclick="filterByCategory('Vegetables')">
                    <h3>Vegetables</h3>
                    <p>Fresh Organic products </p>
                </div>
                <div class="category" onclick="filterByCategory('Dairy products')">
                    <h3>Dairy products</h3>
                    <p>Fresh  products</p>
                </div>
                <div class="category" onclick="filterByCategory('Fruits')">
                    <h3>Fruits</h3>
                    <p>fresh products </p>
                </div>
                <div class="category" onclick="filterByCategory('Grains')">
                    <h3>Grains</h3>
                    <p>Quality Assured</p>
                </div>
            </section>
            <button type="button" class="btn" onclick="toggleHomeCart()" aria-label="View your shopping cart">View Cart</button>

            <section>
                <h2 style="color: white;">Featured Products</h2>
                <div class="products" id="featured-products">
                    <!-- Featured products will be populated here -->
                </div>
            </section>

            <section id="home-cart-section">
                <h2 style="color: white;">Your Cart products </h2>
                <div id="home-cart-items">
                    <!-- Cart items will be populated here -->
                </div>
                <div class="cart-total" id="home-cart-total" style="color: white;">
                    Total: ₹0.00
                </div>
            </section>
        </div>

        <!-- Products Page -->
        <div id="products" class="page">
            <h1>Our Farmer products</h1>
            <div class="filters">
                <h3>Filter Products</h3>
                <div class="filter-group">
                    <label for="category-filter">Category:</label>
                    <select id="category-filter" onchange="applyFilters()" aria-label="Filter products by category">
                        <option value="">All Categories</option>
                        <option value="vegetables">vegetables</option>
                        <option value="dairy products">dairy products</option>
                        <option value="Fruits">Fruits</option>
                        <option value="Grains">Grains</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="brand-filter">Brand:</label>
                    <select id="brand-filter" onchange="applyFilters()" aria-label="Filter products by brand">
                        <option value="">All Brands</option>
                        <option value="Cargil">Cargil</option>
                        <option value="UPL">UPL</option>
                        <option value="Bayer">Bayer</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="price-filter">Price Range:</label>
                    <select id="price-filter" onchange="applyFilters()" aria-label="Filter products by price range">
                        <option value="">All Prices</option>
                        <option value="0-500">₹0 - ₹500</option>
                        <option value="500-1000">₹500 - ₹1000</option>
                        <option value="1000-1500">₹1000 - ₹1500</option>
                        <option value="1500+">₹1500+</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="sort-filter">Sort By:</label>
                    <select id="sort-filter" onchange="applyFilters()" aria-label="Sort products">
                        <option value="name">Name</option>
                        <option value="price-low">Price: Low to High</option>
                        <option value="price-high">Price: High to Low</option>
                        <option value="rating">Rating</option>
                    </select>
                </div>
            </div>
            <div class="products" id="all-products">
                <!-- All products will be populated here -->
            </div>
        </div>

        <!-- Product Detail Page -->
        <div id="product-detail" class="page">
            <div class="product-detail" id="product-detail-content">
                <!-- Product detail will be populated here -->
            </div>
            <div class="reviews" id="product-reviews">
                <!-- Reviews will be populated here -->
            </div>
        </div>

        <!-- Cart Page -->
        <div id="cart-page" class="page">
            <h1>Your Shopping Cart</h1>
            <div id="cart-page-items">
                <!-- Cart items will be populated here -->
            </div>
            <div class="cart-total" id="cart-page-total">
                Total: ₹0.00
            </div>
            <button type="button" class="btn" onclick="showPage('checkout')" aria-label="Securely proceed to checkout">Securely Proceed to Checkout</button>
        </div>

        <!-- Wishlist Page -->
        <div id="wishlist" class="page">
            <h1>Your Wishlist</h1>
            <div id="wishlist-items">
                <!-- Wishlist items will be populated here -->
            </div>
        </div>

        <!-- Farmers Page -->
        <div id="farmers" class="page">
            <h1 style="color: white;">Our Farmers</h1>
            <div class="grid-2">
                <div>
                    <h2>Farmer Profiles</h2>
                    <div id="farmers-list">
                        <!-- Farmer profiles will be populated here -->
                    </div>
                </div>
                <div>
            <h2>Farmer Locations</h2>
            <div id="map" style="height: 400px; width: 100%; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);"></div>
            <h2 style="color: white;">Check Farmer Availability</h2>
            <p style="color: white;">Select a date to see which farmers are available:</p>
            <div style="margin-bottom: 20px;">
                <label for="calendar-month" style="color: white;">Month:</label>
                <select id="calendar-month" style="margin-left: 10px;">
                    <option value="0">January</option>
                    <option value="1">February</option>
                    <option value="2">March</option>
                    <option value="3">April</option>
                    <option value="4">May</option>
                    <option value="5">June</option>
                    <option value="6">July</option>
                    <option value="7">August</option>
                    <option value="8">September</option>
                    <option value="9">October</option>
                    <option value="10">November</option>
                    <option value="11">December</option>
                </select>
                <label for="calendar-year" style="color: white; margin-left: 20px;">Year:</label>
                <input type="number" id="calendar-year" min="2020" max="2030" value="2025" style="margin-left: 10px; width: 80px;">
                <button type="button" class="btn" onclick="navigateCalendar()" style="margin-left: 10px;">Go</button>
            </div>
            <div id="public-availability-calendar">
                        <!-- Public availability calendar will be rendered here -->
                    </div>
            <div id="available-products-list" style="margin-top: 20px;">
                        <!-- List of available products will be displayed here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Login Page -->
        <div id="login" class="page">
            <div class="form-container">
                <h2>Login to Your Account</h2>
                <form id="login-form">
                    <div class="form-group">
                        <label for="login-phone">Phone Number:</label>
                        <input type="tel" id="login-phone" pattern="[0-9]{10}" maxlength="10" placeholder="Enter 10-digit phone number" required>
                        <button type="button" class="btn" id="login-send-otp-btn" onclick="sendLoginOTP()" style="margin-top: 10px;">Send OTP</button>
                    </div>
                    <div class="form-group hidden" id="login-otp-group">
                        <label for="login-otp">Enter OTP:</label>
                        <input type="text" id="login-otp" maxlength="6" placeholder="Enter 6-digit OTP" required>
                    </div>
                    <div class="form-group">
                        <label for="login-name">Full Name (optional, to update):</label>
                        <input type="text" id="login-name" placeholder="Enter your full name">
                    </div>
                    <div class="form-group">
                        <label for="login-email">Email Address (optional, to update):</label>
                        <input type="email" id="login-email" placeholder="Enter your email">
                    </div>
                    <div class="form-group">
                        <label for="login-address">Address (optional, to update):</label>
                        <input type="text" id="login-address" placeholder="Enter your address">
                    </div>
                    <button type="submit" class="btn" style="width: 100%;">Login</button>
                    <div id="login-spinner" class="spinner hidden" aria-hidden="true" style="display:inline-block; vertical-align:middle; margin-left:10px;"></div>
                </form>
                <p style="text-align: center; margin-top: 20px;">
                    Don't have an account?
                    <a href="#" onclick="showPage('register'); return false;" style="color: #27ae60;">Register here</a>
                </p>
            </div>
        </div>

        <!-- Register Page -->
        <div id="register" class="page">
            <div class="form-container">
                <h2>Create New Account</h2>
                <form id="register-form">
                    <div class="form-group">
                        <label for="register-name">Full Name:</label>
                        <input type="text" id="register-name" required>
                    </div>
                    <div class="form-group">
                        <label for="register-email">Email Address:</label>
                        <input type="email" id="register-email" required>
                    </div>
                    <div class="form-group">
                        <label for="register-password">Password:</label>
                        <input type="password" id="register-password" required>
                    </div>
                    <div class="form-group">
                        <label for="register-phone">Phone Number:</label>
                        <input type="tel" id="register-phone" required>
                    </div>
                    <div class="form-group">
                        <label>Account Type:</label>
                        <div>
                            <input type="radio" id="role-farmer" name="role" value="farmer" required>
                            <label for="role-farmer" style="display: inline; margin-left: 5px;">Farmer</label>
                            <input type="radio" id="role-consumer" name="role" value="consumer" required style="margin-left: 15px;">
                            <label for="role-consumer" style="display: inline; margin-left: 5px;">Consumer</label>
                        </div>
                    </div>
                    <button type="submit" class="btn" style="width: 100%;">Register</button>
                    <div id="register-spinner" class="spinner hidden" aria-hidden="true" style="display:inline-block; vertical-align:middle; margin-left:10px;"></div>
                </form>
                <p style="text-align: center; margin-top: 20px;">
                    Already have an account? 
                    <a href="#" onclick="showPage('login'); return false;" style="color: #27ae60;">Login here</a>
                </p>
            </div>
        </div>

      

        <!-- Checkout Page -->
        <div id="checkout" class="page">
            <h1>Checkout</h1>
            <div class="checkout-form grid-2">
                <div>
                    <h3>Shipping Information</h3>
                    <form id="checkout-form">
                        <div class="form-group">
                            <label for="shipping-name">Name:</label>
                            <input type="text" id="shipping-name" required aria-label="Enter your full name for shipping">
                        </div>
                        <div class="form-group">
                            <label for="shipping-address">Address:</label>
                            <input type="text" id="shipping-address" required aria-label="Enter your shipping address">
                        </div>
                        <div class="form-group">
                            <label for="shipping-city">City:</label>
                            <input type="text" id="shipping-city" required aria-label="Enter your city for shipping">
                        </div>
                <div class="form-group">
                    <label for="shipping-zip">ZIP Code:</label>
                    <input type="text" id="shipping-zip" required aria-label="Enter your ZIP code for shipping">
                </div>
                <div class="form-group">
                    <label for="shipping-mobile">Mobile Number:</label>
                    <input type="tel" id="shipping-mobile" pattern="[0-9]{10}" maxlength="10" placeholder="Enter 10-digit mobile number" aria-label="Enter your mobile number for shipping">
                </div>
                <div class="form-group" id="generated-otp-group">
                    <label for="generated-otp">Generated OTP (for verification):</label>
                    <input type="text" id="generated-otp" readonly placeholder="OTP will appear here after sending" aria-label="Generated OTP for verification">
                    <button type="button" class="btn" id="send-otp-btn" onclick="sendOTP()" aria-label="Send OTP to verify mobile number">Send OTP</button>
                    <span id="otp-display" class="otp-display"></span>
                </div>
                <div class="form-group hidden" id="otp-group">
                    <label for="otp-input">Enter OTP:</label>
                    <input type="text" id="otp-input" maxlength="6" placeholder="Enter 6-digit OTP" aria-label="Enter the OTP sent to your mobile">
                    <button type="button" class="btn" onclick="verifyOTP()" aria-label="Verify the entered OTP">Verify OTP</button>
                </div>
                <h3>Payment Options</h3>
                        <div class="payment-options">
                            <div class="payment-option" data-method="upi">
                                <input type="radio" name="payment-method" value="upi" id="upi-radio">
                                <i class="fas fa-mobile-alt payment-icon"></i>
                                <span>UPI</span>
                                <div class="payment-details" id="upi-details">
                                    <div class="upi-options">
                                        <div class="upi-option" data-upi="gpay">
                                            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/2/2e/Google_Pay_Logo.svg/512px-Google_Pay_Logo.svg.png" alt="Google Pay logo">
                                            <span>Google Pay</span>
                                        </div>
                                        <div class="upi-option" data-upi="phonepe">
                                            <img src="https://logos-world.net/wp-content/uploads/2021/03/PhonePe-Logo.png" alt="PhonePe logo">
                                            <span>PhonePe</span>
                                        </div>
                                        <div class="upi-option" data-upi="paytm">
                                            <img src="https://logos-world.net/wp-content/uploads/2020/11/Paytm-Logo.png" alt="Paytm logo">
                                            <span>Paytm</span>
                                        </div>
                                        <div class="upi-option" data-upi="amazonpay">
                                            <img src="https://logos-world.net/wp-content/uploads/2020/11/Amazon-Pay-Logo.png" alt="Amazon Pay logo">
                                            <span>Amazon Pay UPI</span>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="upi-id">UPI ID:</label>
                                        <input type="text" id="upi-id" placeholder="yourname@upi" aria-label="Enter your UPI ID">
                                    </div>
                                </div>
                            </div>
                            <div class="payment-option" data-method="card">
                                <input type="radio" name="payment-method" value="card" id="card-radio">
                                <i class="fas fa-credit-card payment-icon"></i>
                                <span>Credit/Debit Card</span>
                                <div class="payment-details" id="card-details">
                <div class="form-group">
                    <label for="card-number">Card Number:</label>
                    <input type="text" id="card-number" placeholder="1234 5678 9012 3456" maxlength="19" aria-label="Enter your credit or debit card number">
                </div>
                <div class="form-group">
                    <label for="card-expiry">Expiry Date (MM/YY):</label>
                    <input type="text" id="card-expiry" placeholder="MM/YY" maxlength="5" aria-label="Enter card expiry date in MM/YY format">
                </div>
                <div class="form-group">
                    <label for="card-cvv">CVV:</label>
                    <input type="text" id="card-cvv" placeholder="123" maxlength="3" aria-label="Enter card CVV">
                </div>
                <div class="form-group">
                    <label for="card-name">Cardholder Name:</label>
                    <input type="text" id="card-name" placeholder="John Doe" aria-label="Enter cardholder name">
                </div>
                                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                                        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/5e/Visa_Inc._logo.svg/512px-Visa_Inc._logo.svg.png" alt="Visa logo" style="height: 30px;">
                                        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/b/b7/MasterCard_Logo.svg/512px-MasterCard_Logo.svg.png" alt="MasterCard logo" style="height: 30px;">
                                        <img src="https://logos-world.net/wp-content/uploads/2020/11/RuPay-Logo.png" alt="RuPay logo" style="height: 30px;">
                                    </div>
                                </div>
                            </div>
                            <div class="payment-option" data-method="netbanking">
                                <input type="radio" name="payment-method" value="netbanking" id="netbanking-radio">
                                <i class="fas fa-university payment-icon"></i>
                                <span>Net Banking</span>
                                <div class="payment-details" id="netbanking-details">
                                    <div class="form-group">
                                        <label for="bank-select">Select Bank:</label>
                                        <select id="bank-select" aria-label="Select your bank for net banking">
                                            <option value="">Choose your bank</option>
                                            <option value="sbi">State Bank of India</option>
                                            <option value="hdfc">HDFC Bank</option>
                                            <option value="icici">ICICI Bank</option>
                                            <option value="axis">Axis Bank</option>
                                            <option value="pnb">Punjab National Bank</option>
                                            <option value="kotak">Kotak Mahindra Bank</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="payment-option" data-method="cod">
                                <input type="radio" name="payment-method" value="cod" id="cod-radio">
                                <i class="fas fa-truck payment-icon"></i>
                                <span>Cash on Delivery</span>
                            </div>
                            <div class="payment-option" data-method="wallet">
                                <input type="radio" name="payment-method" value="wallet" id="wallet-radio">
                                <i class="fas fa-wallet payment-icon"></i>
                                <span>Gift Card / Wallet Balance</span>
                                <div class="payment-details" id="wallet-details">
                                    <div class="form-group">
                                        <label for="gift-card">Gift Card Code:</label>
                                        <input type="text" id="gift-card" placeholder="Enter gift card code" aria-label="Enter gift card code">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="security-message">
                            <i class="fas fa-shield-alt"></i> Your payment details are encrypted and secure.
                        </div>
                        <div class="spinner hidden" id="checkout-spinner"></div>
                        <button type="button" class="pay-now-btn" onclick="validateAndPay()">Pay Now</button>
                    </form>
                </div>
                <div class="order-summary">
                    <h3>Order Summary</h3>
                    <div id="checkout-items">
                        <!-- Order items will be populated here -->
                    </div>
                    <div class="order-breakdown">
                        <div class="breakdown-item">
                            <span>Subtotal:</span>
                            <span id="subtotal">₹0.00</span>
                        </div>
                        <div class="breakdown-item">
                            <span>Tax (GST 18%):</span>
                            <span id="tax">₹0.00</span>
                        </div>
                        <div class="breakdown-item">
                            <span>Shipping:</span>
                            <span id="shipping-charge">₹50.00</span>
                        </div>
                        <div class="breakdown-item">
                            <span>Discount:</span>
                            <span id="discount">-₹0.00</span>
                        </div>
                        <div class="breakdown-item grand-total">
                            <span>Total Payable:</span>
                            <span id="checkout-total">₹0.00</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Profile Page -->
        <div id="profile" class="page">
            <div class="profile-container">
                <div class="profile-header">
            <img class="profile-photo" id="profile-photo" src="https://static.vecteezy.com/system/resources/thumbnails/020/699/763/small_2x/natural-scenic-beautiful-rice-field-and-sunset-at-thailand-free-photo.jpg" alt="User profile photo">
                    <h2 class="profile-name" id="profile-name">Please login to view your profile.</h2>
                    <button id="edit-profile-btn" onclick="toggleEditMode()" aria-label="Edit your profile information">Edit Profile</button>
    <br>
    <button id="logout-btn" onclick="logout()" aria-label="Logout from your account">Logout</button>
                </div>
                <div class="profile-details hidden" id="profile-details">
                    <div class="detail-card">
                        <h3>Contact Information</h3>
                        <div class="detail-item">
                            <span class="detail-label">Email:</span>
                            <span class="detail-value" id="profile-email"></span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Phone:</span>
                            <span class="detail-value" id="profile-phone"></span>
                        </div>
                    </div>
                    <div class="detail-card">
                        <h3>End-to-End Encrypted Personal Details</h3>
                        <div class="detail-item">
                            <span class="detail-label">Date of Birth:</span>
                            <span class="detail-value" id="profile-dob"></span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Address:</span>
                            <span class="detail-value" id="profile-address"></span>
                        </div>
                    </div>
                    <div class="detail-card">
                        <h3>Bio</h3>
                        <p class="detail-value" id="profile-bio"></p>
                    </div>
                    <div class="detail-card" id="farmer-tools-card" style="display: none;">
                        <h3>Farmer Tools</h3>
                        <button type="button" class="btn" onclick="showInventoryManagement()" aria-label="Access inventory management and sales tracking tools">Manage Inventory & Sales Tracking</button>
                    </div>
                    <div class="detail-card" id="product-catalogs-card" style="display: none;">
                        <h3>Product Catalogs</h3>
                        <div id="product-catalogs">
                            <!-- Farmer's products will be listed here -->
                        </div>
                    </div>
                    <div class="detail-card" id="availability-calendar-card" style="display: none;">
                        <h3>Availability Calendar</h3>
                        <p>Select dates when your products are available:</p>
                        <div id="availability-calendar">
                            <!-- Calendar will be rendered here -->
                        </div>
                        <button type="button" class="btn" onclick="saveAvailability()" aria-label="Save selected availability dates">Save Availability</button>
                    </div>
                    <div class="detail-card" id="sales-tracking-card" style="display: none;">
                        <h3>Inventory Management & Sales Tracking</h3>
                        <div id="sales-tracking">
                            <div class="inventory-tools">
                                <h4>Product Inventory</h4>
                                <div id="inventory-list">
                                    <!-- Inventory items will be populated here -->
                                </div>
                                <button type="button" class="btn" onclick="updateInventory()" aria-label="Update inventory quantities">Update Inventory</button>
                            </div>
                            <div class="sales-tools">
                                <h4>Sales History</h4>
                                <div id="sales-history">
                                    <!-- Sales history will be populated here -->
                                </div>
                                <button type="button" class="btn btn-secondary" onclick="exportSalesData()" aria-label="Export sales data">Export Sales Data</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Inventory Page -->
        <div id="inventory" class="page">
            <h1>Inventory Management</h1>
            <div id="inventory-content">
                <!-- Inventory content will be loaded here -->
            </div>
            <div class="order-history">
                <h3>Order History</h3>
                <!-- Order history will be populated here -->
            </div>
        </div>

        <!-- Add Product Modal -->
        <div id="add-product-modal" class="modal">
            <div class="modal-content">
                <h3>Add New Product</h3>
                <form id="add-product-form">
                    <div class="form-group">
                        <label for="product-name">Product Name:</label>
                        <input type="text" id="product-name" required>
                    </div>
                    <div class="form-group">
                        <label for="product-description">Description:</label>
                        <textarea id="product-description" rows="3" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="product-price">Price (₹):</label>
                        <input type="number" id="product-price" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="product-category">Category:</label>
                        <select id="product-category" required>
                            <option value="">Select Category</option>
                            <option value="insecticide">Insecticide</option>
                            <option value="dairy products">dairy products</option>
                            <option value="Fruits">Fruits</option>
                            <option value="Grains">Grains</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="product-quantity">Quantity:</label>
                        <input type="number" id="product-quantity" min="1" required>
                    </div>
                    <div class="form-group">
                        <label for="product-image">Image URL (optional):</label>
                        <input type="url" id="product-image" placeholder="https://example.com/image.jpg">
                    </div>
                    <div class="modal-buttons">
                        <button type="button" class="cancel-modal" onclick="closeAddProductModal()">Cancel</button>
                        <button type="submit" class="confirm-cancel">Add Product</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Cancel Order Modal -->
        <div id="cancel-modal" class="modal">
            <div class="modal-content">
                <h3>Cancel Order</h3>
                <p>Are you sure you want to cancel this order? Please select a reason:</p>
                <select id="cancel-reason" aria-label="Select reason for order cancellation">
                    <option value="">Select a reason</option>
                    <option value="Changed my mind">Changed my mind</option>
                    <option value="Found a better price">Found a better price</option>
                    <option value="Delivery delay">Delivery delay</option>
                    <option value="Wrong item ordered">Wrong item ordered</option>
                    <option value="Other">Other</option>
                </select>
                <div class="modal-buttons">
        <button class="cancel-modal" onclick="closeCancelModal()" aria-label="Cancel modal">Cancel</button>
        <button class="confirm-cancel" onclick="confirmCancelOrder()" aria-label="Confirm order cancellation">Confirm Cancellation</button>
                </div>
            </div>
        </div>

        <!-- Cancel Product Modal -->
        <div id="cancel-product-modal" class="modal">
            <div class="modal-content">
                <h3>Cancel Product</h3>
                <p>Are you sure you want to cancel <span id="cancel-product-name"></span> from this order? Please select a reason:</p>
                <select id="cancel-product-reason" aria-label="Select reason for canceling product">
                    <option value="">Select a reason</option>
                    <option value="Changed my mind">Changed my mind</option>
                    <option value="Found a better price">Found a better price</option>
                    <option value="Delivery delay">Delivery delay</option>
                    <option value="Wrong item ordered">Wrong item ordered</option>
                    <option value="Other">Other</option>
                </select>
                <div class="modal-buttons">
                    <button class="cancel-modal" onclick="closeCancelProductModal()" aria-label="Cancel modal">Cancel</button>
                    <button class="confirm-cancel" onclick="confirmCancelProduct()" aria-label="Confirm canceling product">Confirm Cancellation</button>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer>
        <p>&copy; 2025 LOCAL FOOD MARKET PLACE. All rights reserved.</p>
        <P>THANK YOU FOR VISITING OUR SITE </P>
    </footer>

    <script>
        // Sample users data (farmers with locations)
        let sampleUsers = [
            {
                id: 1,
                name: 'Farmer John',
                email: 'john@example.com',
                password: 'pass',
                phone: '9876543210',
                dob: '1980-01-01',
                address: 'Farm Road, Village A',
                bio: 'Organic farmer specializing in vegetables.',
                role: 'Farmer',
                location: { lat: 12.9716, lng: 77.5946 }, // Bangalore area
                availability: ['2025-01-01', '2025-01-02', '2025-01-03', '2025-01-04', '2025-01-05']
            },
            {
                id: 2,
                name: 'Dairy Farmer Mary',
                email: 'mary@example.com',
                password: 'pass',
                phone: '9876543211',
                dob: '1975-05-15',
                address: 'Dairy Lane, Village B',
                bio: 'Providing fresh dairy products.',
                role: 'Farmer',
                location: { lat: 13.0827, lng: 80.2707 } // Chennai area
            },
            {
                id: 3,
                name: 'Fruit Grower Raj',
                email: 'raj@example.com',
                password: 'pass',
                phone: '9876543212',
                dob: '1985-03-20',
                address: 'Orchard Street, Village C',
                bio: 'Growing seasonal fruits.',
                role: 'Farmer',
                location: { lat: 28.6139, lng: 77.2090 } // Delhi area
            },
            {
                id: 4,
                name: 'Grain Farmer Kumar',
                email: 'kumar@example.com',
                password: 'pass',
                phone: '9876543213',
                dob: '1970-11-10',
                address: 'Grain Fields, Village D',
                bio: 'Cultivating high-quality grains.',
                role: 'Farmer',
                location: { lat: 19.0760, lng: 72.8777 } // Mumbai area
            }
        ];

        // Initialize sample users if none exist
        if (!localStorage.getItem('users')) {
            localStorage.setItem('users', JSON.stringify(sampleUsers));
        }

        function generateRandomAvailability() {
            const start = new Date();
            const end = new Date();
            end.setFullYear(end.getFullYear() + 1);
            const randomTime = start.getTime() + Math.random() * (end.getTime() - start.getTime());
            const randomDate = new Date(randomTime);
            const date = randomDate.toISOString().split('T')[0];
            const day = randomDate.toLocaleDateString('en-US', { weekday: 'long' });
            const year = randomDate.getFullYear();
            return { date, day, year };
        }

        function generateRandomAvailabilityDates(count = 5) {
            const dates = [];
            for (let i = 0; i < count; i++) {
                const { date } = generateRandomAvailability();
                dates.push(date);
            }
            return dates;
        }

        // Sample product data
        let products = JSON.parse(localStorage.getItem('products')) || [
            {
                id: 1,
                name: "Potato per kg",
                category: "vegetables",
                brand: "Cargil",
                price: 25.00,
                description: "Rich in vitamins and minerals.",
                image: "https://tse3.mm.bing.net/th/id/OIP.VbmDVZoch2S1fXeq1f44qQHaE8?cb=12&rs=1&pid=ImgDetMain&o=7&rm=3",
                rating: 4.5,
                farmerId: 1,
                reviews: [
                    { user: "Farmer John", rating: 5, comment: "Great product, Fresh and Organic!" },
                    { user: "Crop Expert", rating: 4, comment: "Good value for money." }
                ]
            },
            {
                id: 2,
                name: "MILK per litre",
                category: "dairy products",
                brand: "UPL",
                price: 60.00,
                description: "A nutritious liquid.",
                image: "https://www.iowafarmbureau.com/Article/Live/ThumbnailImage?articleid=269111",
                rating: 4.2,
                farmerId: 2,
                reviews: [
                    { user: "Green Thumb", rating: 4, comment: "A nutritious liquid." }
                ]
            },
            {
                id: 3,
                name: "Apple per kg",
                category: "Fruits",
                brand: "Bayer",
                price: 50.25,
                description: "tasty and crunchy fruit.",
                image: "https://tse1.mm.bing.net/th/id/OIP.R5E0MvSCeRIKiwD1We-qXwHaE8?cb=12&rs=1&pid=ImgDetMain&o=7&rm=3",
                rating: 4.0,
                farmerId: 3,
                reviews: [
                    { user: "Weed Warrior", rating: 4, comment: "tasty and delicious." }
                ]
            },
            {
                id: 4,
                name: "Bullet Rice per 25kg",
                category: "Grains",
                brand: "Cargil",
                price: 1045.00,
                description: "High Quality Rice.",
                image: "https://thumbs.dreamstime.com/b/hands-holding-rice-pouring-burlap-sack-close-up-image-persons-handful-white-falling-which-full-taken-328376010.jpg",
                rating: 4.3,
                farmerId: 4,
                reviews: [
                    { user: "Farm Manager", rating: 5, comment: "Finally got Best Quality Rice!" }
                ]
            },
            {
                id: 5,
                name: "Tomato per kg",
                category: "vegetables",
                brand: "UPL",
                price: 30.00,
                description: "Natural and  organic .",
                image: "https://wallpaperaccess.com/full/1463013.jpg",
                rating: 4.7,
                farmerId: 1,
                reviews: [
                    { user: "Organic Farmer", rating: 5, comment: "Perfect for my health." },
                    { user: "Eco Warrior", rating: 4, comment: "Tasty ." }
                ]
            },
            {
                id: 6,
                name: "Carrot per kg",
                category: "vegetables",
                brand: "Cargil",
                price: 20.00,
                description: "Fresh Organic Carrot.",
                image: "https://thumbs.dreamstime.com/b/farmer-holding-bunch-carrots-agricultural-field-growing-harvesting-leafy-vegetables-autumn-season-generated-ai-304052010.jpg",
                rating: 4.4,
                farmerId: 1,
                reviews: [
                    { user: "Food  Expert", rating: 5, comment: "Tasty Carrot." }
                ]
            },
            {
                id: 7,
                name: "Cabbage per 5kg",
                category: "vegetables",
                brand: "UPL",
                price: 135.00,
                description: "Fresh and Healthy.",
                image: "https://img.freepik.com/premium-photo/farmer-is-harvesting-cabbage-from-field_132358-15237.jpg",
                rating: 4.3,
                farmerId: 1,
                reviews: [
                    { user: "Crop Specialist", rating: 4, comment: "Good and tasty." }
                ]
            },
            {
                id: 8,
                name: "Mango per 5kg",
                category: "Fruits",
                brand: "Bayer",
                price: 757.50,
                description: "Sweet and Tasty .",
                image: "https://tse3.mm.bing.net/th/id/OIP.Q6DnvktmM0_zbSHKs-x_IgHaEJ?cb=12&w=996&h=558&rs=1&pid=ImgDetMain&o=7&rm=3",
                rating: 4.1,
                farmerId: 3,
                reviews: [
                    { user: "Mango Farmer", rating: 4, comment: "Effective taste." }
                ]
            },
            {
                id: 9,
                name: "Bannana per 5 dozen",
                category: "Fruits",
                brand: "Cargil",
                price: 385.00,
                description: "Sweet and Tasty.",
                image: "https://tse4.mm.bing.net/th/id/OIP.PtmZTNyIua-euOpYLA1HBgHaE8?cb=12&pid=ImgDet&w=474&h=316&rs=1&o=7&rm=3",
                rating: 4.0,
                farmerId: 3,
                reviews: [
                    { user: "Fruits Manager", rating: 4, comment: "Organic and tasty." }
                ]
            },
            {
                id: 10,
                name: "Onions per 15kg",
                category: "vegetables",
                brand: "UPL",
                price: 552.50,
                description: "Fresh and tasty.",
                image: "https://tse4.mm.bing.net/th/id/OIP.sMvEuinMLH-kgNkWWKsUmQHaFO?cb=12&rs=1&pid=ImgDetMain&o=7&rm=3",
                rating: 4.2,
                farmerId: 1,
                reviews: [
                    { user: "Prajwal", rating: 4, comment: "Organic and tasty." }
                ]
            },
            {
                id: 11,
                name: "Pumkin per 10kg",
                category: "vegetables",
                brand: "Bayer",
                price: 625.00,
                description: "Fresh and perfect for carving.",
                image: "https://tse1.explicit.bing.net/th/id/OIP.A9-WZyQMQtr96JsY5aBTnQHaEo?cb=12&w=1920&h=1200&rs=1&pid=ImgDetMain&o=7&rm=3",
                rating: 4.5,
                farmerId: 1,
                reviews: [
                    { user: "Organic Grower", rating: 5, comment: "Tasty and beneficial ." }
                ]
            },
            {
                id: 12,
                name: "Beetroot per 15kg",
                category: "vegetables",
                brand: "Cargil",
                price: 1100.00,
                description: "Fresh and organic.",
                image: "https://cdn.pixabay.com/photo/2015/03/24/08/52/beetroot-687251_1280.jpg",
                rating: 4.3,
                farmerId: 1,
                reviews: [
                    { user: "chandu", rating: 4, comment: "Excellent for blood improvement." }
                ]
            },
            {
                id: 13,
                name: "Spinach per 5kg",
                category: "vegetables",
                brand: "UPL",
                price: 700.00,
                description: "Fresh and organic.",
                image: "https://images.unsplash.com/photo-1576045057995-568f588f82fb?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=MnwxMjA3fDB8MXxzZWFyY2h8Mnx8c3BpbmFjaHx8MHx8fHwxNjE1MjQ1NjIz&ixlib=rb-1.2.1&q=80&w=1080",
                rating: 4.1,
                farmerId: 1,
                reviews: [
                    { user: "Soil Expert", rating: 4, comment: "Good and healthy." }
                ]
            },
            {
                id: 14,
                name: "Green Chilly per 10kg",
                category: "vegetables",
                brand: "Bayer",
                price: 590.00,
                description: "Hot and Spicy.",
                image: "https://tse2.mm.bing.net/th/id/OIP.WR0F9JkC58LCTNpwU5Qu1gHaHa?cb=12&rs=1&pid=ImgDetMain&o=7&rm=3",
                rating: 4.4,
                farmerId: 1,
                reviews: [
                    { user: "Ramesh", rating: 5, comment: "more spicy and hot" }
                ]
            },
            {
                id: 15,
                name: "Bitter Melon per 10kg",
                category: "vegetables",
                brand: "Cargil",
                price: 525.00,
                description: "Organic and Fresh.",
                image: "https://specialtyproduce.com/sppics/9184.png",
                rating: 4.2,
                farmerId: 1,
                reviews: [
                    { user: "vegetable Manager", rating: 4, comment: "Effective on various health issues." }
                ]
            },
            {
                id: 16,
                name: "Ghee per litre",
                category: "dairy products",
                brand: "UPL",
                price: 1075.00,
                description: "Tasty and chemical free.",
                image: "https://5.imimg.com/data5/HI/PR/MY-9948889/dairy-farm-ghee.jpg",
                rating: 4.6,
                farmerId: 2,
                reviews: [
                    { user: "Hamenth", rating: 5, comment: "Very tasty." }
                ]
            },
            {
                id: 17,
                name: "Radish per 10kg",
                category: "vegetables",
                brand: "Bayer",
                price: 769.00,
                description: "Fresh and Organic.",
                image: "https://www.outsidepride.com/images/products/detail/pasture/daikonradish2.jpg",
                rating: 4.3,
                farmerId: 1,
                reviews: [
                    { user: "Systemic User", rating: 4, comment: "Good and Organic." }
                ]
            },
            {
                id: 18,
                name: "Orange per dozen",
                category: "Fruits",
                brand: "Cargil",
                price: 140.00,
                description: "Fresh and Tasty.",
                image: "https://th.bing.com/th/id/R.fdfa4be96a39b9cfb21e852b910101f2?rik=VCl57JSAuYF%2fpg&riu=http%3a%2f%2f3.bp.blogspot.com%2f-tVoQ9O2IU_E%2fUDzWrWgr2TI%2fAAAAAAAAIZ8%2fojl3vvQ-XV8%2fs1600%2fOrange%2bFruits%2bWallpapers%2b1.jpg&ehk=SRm6PUUyZ%2f2XJQnkWx9o7XofkTwa8zcmVr0ytJXlHEg%3d&risl=&pid=ImgRaw&r=0",
                rating: 4.5,
                farmerId: 3,
                reviews: [
                    { user: "raju", rating: 5, comment: "best for value." }
                ]
            },
            {
                id: 19,
                name: "Cucumber per 10kg",
                category: "vegetables",
                brand: "UPL",
                price: 987.50,
                description: "Fresh and organic.",
                image: "https://cdn.pixabay.com/photo/2024/05/03/09/59/ai-generated-8736707_640.jpg",
                rating: 4.4,
                farmerId: 1,
                reviews: [
                    { user: "Manju", rating: 4, comment: "Good and Tasty." }
                ]
            },
            {
                id: 20,
                name: "Yogurt per litre",
                category: "dairy products",
                brand: "Bayer",
                price: 334.00,
                description: "Tasty.",
                image: "https://tse1.mm.bing.net/th/id/OIP.PminCvJfnlw_94DTMyECdgHaE7?cb=12&rs=1&pid=ImgDetMain&o=7&rm=3",
                rating: 4.2,
                farmerId: 2,
                reviews: [
                    { user: "krishna", rating: 4, comment: "Sweet and tasty." }
                ]
            }
        ];

        // Global variables
        let currentUser = null;
        let cart = JSON.parse(localStorage.getItem('cart')) || [];
        let wishlist = JSON.parse(localStorage.getItem('wishlist')) || [];
        let currentProduct = null;
        let deletePhotoFlag = false;
        let otpSent = false;
        let otpVerified = false;
        let generatedOTP = null;
        let selectedDate = null;
        let currentCalendarMonth = new Date().getMonth();
        let currentCalendarYear = new Date().getFullYear();

        // Wishlist functionality
        function addToWishlist(productId) {
            const product = products.find(p => p.id === productId);
            if (!product || wishlist.some(item => item.id === productId)) return;
            wishlist.push(product);
            saveWishlist();
            updateWishlistDisplay();
        }

        function removeFromWishlist(productId) {
            wishlist = wishlist.filter(item => item.id !== productId);
            saveWishlist();
            updateWishlistDisplay();
        }

        function toggleWishlist(productId) {
            if (wishlist.some(item => item.id === productId)) {
                removeFromWishlist(productId);
            } else {
                addToWishlist(productId);
            }
        }

        function saveWishlist() {
            localStorage.setItem('wishlist', JSON.stringify(wishlist));
        }

        function loadWishlist() {
            wishlist = JSON.parse(localStorage.getItem('wishlist')) || [];
            updateWishlistDisplay();
        }

        function updateWishlistDisplay() {
            const container = document.getElementById('wishlist-items');
            if (!container) return;
            container.innerHTML = wishlist.length ? wishlist.map(product => `
                <div class="product">
                    <img src="${product.image}" alt="${product.name}" onerror="this.src='data:image/svg+xml,%3Csvg width=%22250%22 height=%22200%22 xmlns=%22http://www.w3.org/2000/svg%22%3E%3Crect width=%22250%22 height=%22200%22 fill=%22%23ccc%22/%3E%3Ctext x=%22125%22 y=%22100%22 fill=%22%23fff%22 text-anchor=%22middle%22 dy=%220.35em%22 font-size=%2214%22%3ENo Image%3C/text%3E%3C/svg%3E'">
                    <div class="product-info">
                        <h3>${product.name}</h3>
                        <p>${product.description}</p>
                        <p class="price">₹${product.price.toFixed(2)}</p>
                        <button class="btn" onclick="addToCart(${product.id})" aria-label="Add ${product.name} to cart">Add to Cart</button>
                        <button class="btn btn-danger" onclick="removeFromWishlist(${product.id})" aria-label="Remove ${product.name} from wishlist">Remove from Wishlist</button>
                        <button class="btn btn-secondary" onclick="showPage('product-detail', ${product.id})" aria-label="View details for ${product.name}">View Details</button>
                    </div>
                </div>
            `).join('') : '<p>Your wishlist is empty.</p>';
        }

    // Initialize the application
document.addEventListener('DOMContentLoaded', function() {
    loadProducts();
    updateCartCount();
    loadCart();
    loadWishlist();
    // Form event listeners (guarded)
    const loginFormEl = document.getElementById('login-form');
    const registerFormEl = document.getElementById('register-form');
    const checkoutFormEl = document.getElementById('checkout-form');
    const addProductFormEl = document.getElementById('add-product-form');
    if (loginFormEl) loginFormEl.addEventListener('submit', handleLogin);
    if (registerFormEl) registerFormEl.addEventListener('submit', handleRegister);
    if (checkoutFormEl) checkoutFormEl.addEventListener('submit', handleCheckout);
    if (addProductFormEl) addProductFormEl.addEventListener('submit', handleAddProduct);
    // Dark mode toggle
    const darkModeToggle = document.getElementById('dark-mode-toggle');
    if (darkModeToggle) {
        // Load dark mode state
        const isDarkMode = localStorage.getItem('darkMode') === 'true';
        if (isDarkMode) {
            document.body.classList.add('dark-mode');
            darkModeToggle.textContent = '☀️';
        } else {
            darkModeToggle.textContent = '🌙';
        }
        darkModeToggle.addEventListener('click', function() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDark);
            this.textContent = isDark ? '☀️' : '🌙';
        });
    }

    // Cart keyboard accessibility: trap focus and handle Escape
    (function setupCartKeyboardAccessibility() {
        const cart = document.getElementById('cart');
        const toggle = document.getElementById('cart-toggle');
        if (!cart || !toggle) return;

        const focusableSelector = 'a[href], button:not([disabled]), input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])';
        let lastFocused = null;

        function trapFocus(e) {
            if (!cart.classList.contains('open')) return;
            const focusable = Array.from(cart.querySelectorAll(focusableSelector)).filter(el => el.offsetParent !== null);
            if (focusable.length === 0) return;
            const first = focusable[0];
            const last = focusable[focusable.length - 1];

            if (e.key === 'Tab') {
                if (e.shiftKey) {
                    if (document.activeElement === first) {
                        e.preventDefault();
                        last.focus();
                    }
                } else {
                    if (document.activeElement === last) {
                        e.preventDefault();
                        first.focus();
                    }
                }

                // Reflect login state on initial load
                try { checkLoginStatus(); } catch (e) { /* ignore if function not yet defined */ }
            } else if (e.key === 'Escape') {
                // Close cart on Escape
                toggleCart();
                if (toggle) toggle.focus();
            }
        }

        document.addEventListener('keydown', trapFocus);

        // Save last focused element before opening and restore after closing
        const origToggle = toggle.onclick;
        toggle.addEventListener('click', function(e) {
            // store last focused
            if (!cart.classList.contains('open')) {
                lastFocused = document.activeElement;
            }
        });

        // Observe cart open/close to set focus appropriately
        const observer = new MutationObserver(() => {
            if (cart.classList.contains('open')) {
                // focus first focusable element inside cart
                const focusable = cart.querySelectorAll(focusableSelector);
                if (focusable.length) focusable[0].focus();
            } else {
                // restore
                if (lastFocused && typeof lastFocused.focus === 'function') lastFocused.focus();
            }
        });

        observer.observe(cart, { attributes: true, attributeFilter: ['class'] });
    })();

    // Close cancel modal on Escape (defensive)
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const modal = document.getElementById('cancel-modal');
            if (modal && modal.style.display === 'flex') {
                closeCancelModal();
            }
        }
    });
});

        // Page navigation
        let previousOverlayPage = null;
        function showPage(pageId, productId = null) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));

            // Defensive: ensure the target page exists
            const target = document.getElementById(pageId);
            if (!target) {
                console.warn(`showPage: page with id '${pageId}' not found`);
                // Fallback to home
                const home = document.getElementById('home');
                if (home) home.classList.add('active');
            } else {
                // Show the requested page
                target.classList.add('active');
            }

            // Overlay inert logic
            const overlays = ['login', 'register', 'product-detail'];
            if (overlays.includes(pageId)) {
                setBackgroundInert(true);
                previousOverlayPage = pageId;
            } else if (previousOverlayPage && overlays.includes(previousOverlayPage)) {
                setBackgroundInert(false);
                previousOverlayPage = null;
            }

            // Special handling for product detail
            if (pageId === 'product-detail' && productId) {
                loadProductDetail(productId);
            }

            // Load profile and order history for profile page
            if (pageId === 'profile') {
                loadProfile();
                loadOrderHistory();
            }

    // Fill shipping info for checkout page
    if (pageId === 'checkout') {
        fillShippingInfo();
        updateCheckoutSummary();
    }

        // Load farmers and initialize map for farmers page
    if (pageId === 'farmers') {
        loadFarmers();
        initializeMap();
        renderPublicCalendar();
        // Set calendar controls to current values
        document.getElementById('calendar-month').value = currentCalendarMonth;
        document.getElementById('calendar-year').value = currentCalendarYear;
    }

    // Load inventory content for inventory page
    if (pageId === 'inventory') {
        loadOrderHistory();
    }

    // Update URL (optional, for better UX)
    history.pushState(null, null, `#${pageId}`);
        }

        // Mobile menu toggle for small screens
        function toggleMobileMenu() {
            const navLinks = document.getElementById('nav-links');
            if (!navLinks) return;
            const isOpen = navLinks.classList.contains('mobile-open');
            setMobileMenuState(!isOpen);
        }

        // Enhance mobile menu accessibility and close behaviors
        function setMobileMenuState(open) {
            const navLinks = document.getElementById('nav-links');
            const toggle = document.getElementById('mobile-menu-toggle');
            if (!navLinks || !toggle) return;
            if (open) {
                navLinks.classList.add('mobile-open');
                toggle.setAttribute('aria-expanded', 'true');
                toggle.textContent = '✕';
            } else {
                navLinks.classList.remove('mobile-open');
                toggle.setAttribute('aria-expanded', 'false');
                toggle.textContent = '☰';
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const toggle = document.getElementById('mobile-menu-toggle');
            const navLinks = document.getElementById('nav-links');
            if (toggle) toggle.setAttribute('aria-expanded', 'false');
            if (toggle) toggle.addEventListener('click', function() { setMobileMenuState(!(navLinks && navLinks.classList.contains('mobile-open'))); });

            // Close mobile menu on Escape
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') setMobileMenuState(false);
            });

            // Close mobile menu when a navigation link is clicked
            if (navLinks) {
                navLinks.addEventListener('click', function(e) {
                    if (e.target && e.target.tagName === 'A') setMobileMenuState(false);
                });
            }
        });

        // Load products on homepage and products page
        function loadProducts() {
            const featuredContainer = document.getElementById('featured-products');
            const allProductsContainer = document.getElementById('all-products');

            // Display featured products (first 4)
            const featuredProducts = products.slice(0, 4);
            if (featuredContainer) {
                featuredContainer.innerHTML = featuredProducts.map(product => createProductCard(product)).join('');
            }

            // Display all products
            if (allProductsContainer) {
                allProductsContainer.innerHTML = products.map(product => createProductCard(product)).join('');
            }
        }

        // Create product card HTML
function createProductCard(product) {
    const isInWishlist = wishlist.some(item => item.id === product.id);
    return `
        <div class="product">
    <img src="${product.image}" alt="${product.name}" onerror="this.src='data:image/svg+xml,%3Csvg width=%22250%22 height=%22200%22 xmlns=%22http://www.w3.org/2000/svg%22%3E%3Crect width=%22250%22 height=%22200%22 fill=%22%23ccc%22/%3E%3Ctext x=%22125%22 y=%22100%22 fill=%22%23fff%22 text-anchor=%22middle%22 dy=%220.35em%22 font-size=%2214%22%3ENo Image%3C/text%3E%3C/svg%3E'">
            <div class="product-info">
                <h3>${product.name}</h3>
                <p>${product.description}</p>
                <p class="price">₹${product.price.toFixed(2)}</p>
    <button class="btn" onclick="addToCart(${product.id})" aria-label="Add ${product.name} to cart">Add to Cart</button>
    <button class="btn btn-secondary" onclick="showPage('product-detail', ${product.id})" aria-label="View details for ${product.name}">View Details</button>
    <button class="btn btn-ghost" onclick="toggleWishlist(${product.id})" aria-label="Toggle wishlist for ${product.name}"><i class="fas fa-heart ${isInWishlist ? 'text-red-500' : ''}"></i></button>
            </div>
        </div>
    `;
}

        // Load product detail
        function loadProductDetail(productId) {
            currentProduct = products.find(p => p.id === productId);
            if (!currentProduct) return;

            const detailContainer = document.getElementById('product-detail-content');
            const reviewsContainer = document.getElementById('product-reviews');

            detailContainer.innerHTML = `
                <div class="product-images">
                    <img src="${currentProduct.image}" alt="${currentProduct.name}" onerror="this.src='data:image/svg+xml,%3Csvg width=%22250%22 height=%22200%22 xmlns=%22http://www.w3.org/2000/svg%22%3E%3Crect width=%22250%22 height=%22200%22 fill=%22%23ccc%22/%3E%3Ctext x=%22125%22 y=%22100%22 fill=%22%23fff%22 text-anchor=%22middle%22 dy=%220.35em%22 font-size=%2214%22%3ENo Image%3C/text%3E%3C/svg%3E'">
                <div>
                    <h1>${currentProduct.name}</h1>
                    <p class="price">₹${currentProduct.price.toFixed(2)}</p>
                    <p>${currentProduct.description}</p>
                    <p>Brand: ${currentProduct.brand}</p>
                    <p>Category: ${currentProduct.category}</p>
                    <p>Rating: ${currentProduct.rating}/5</p>
                    <button class="btn" onclick="addToCart(${currentProduct.id})" aria-label="Add ${currentProduct.name} to cart">Add to Cart</button>
                </div>
            `;

            reviewsContainer.innerHTML = `
                <h2>Customer Reviews</h2>
                ${currentProduct.reviews.map(review => `
                    <div class="review">
                        <h4>${review.user}</h4>
                        <p>Rating: ${review.rating}/5</p>
                        <p>${review.comment}</p>
                    </div>
                `).join('')}
            `;
        }

        // Cart functionality
        function addToCart(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            const existingItem = cart.find(item => item.id === productId);
            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                cart.push({ ...product, quantity: 1 });
            }

            updateCart();
            updateCartCount();
            saveCart();
        }

        function updateCart() {
            const cartItemsContainer = document.getElementById('cart-items');
            const cartPageItemsContainer = document.getElementById('cart-page-items');
            const totalElement = document.getElementById('cart-total');
            const cartPageTotalElement = document.getElementById('cart-page-total');
            let total = 0;
            const cartHTML = cart.map(item => {
                const subtotal = item.price * item.quantity;
                total += subtotal;
                return `
                    <div class="cart-item">
                        <img src="${item.image}" alt="${item.name}" onerror="this.src='data:image/svg+xml,%3Csvg width=%22250%22 height=%22200%22 xmlns=%22http://www.w3.org/2000/svg%22%3E%3Crect width=%22250%22 height=%22200%22 fill=%22%23ccc%22/%3E%3Ctext x=%22125%22 y=%22100%22 fill=%22%23fff%22 text-anchor=%22middle%22 dy=%220.35em%22 font-size=%2214%22%3ENo Image%3C/text%3E%3C/svg%3E'">
                        <div class="cart-item-info">
                            <h4>${item.name}</h4>
                            <p>₹${item.price.toFixed(2)}</p>
                            <div class="quantity-controls">
                                <button onclick="decreaseQuantity(${item.id})" aria-label="Decrease quantity">-</button>
                                <span>${item.quantity}</span>
                                <button onclick="increaseQuantity(${item.id})" aria-label="Increase quantity">+</button>
                            </div>
                            <p>Subtotal: ₹${subtotal.toFixed(2)}</p>
                            <button onclick="removeFromCart(${item.id})" aria-label="Remove ${item.name} from cart">Remove</button>
                        </div>
                    </div>
                `;
            }).join('');
            if (cartItemsContainer) cartItemsContainer.innerHTML = cartHTML || '<p>Your cart is empty.</p>';
            if (cartPageItemsContainer) cartPageItemsContainer.innerHTML = cartHTML || '<p>Your cart is empty.</p>';
            if (totalElement) totalElement.textContent = `Total: ₹${total.toFixed(2)}`;
            if (cartPageTotalElement) cartPageTotalElement.textContent = `Total: ₹${total.toFixed(2)}`;
            // Update checkout summary
            try { updateCheckoutSummary(); } catch (e) { /* ignore if not present */ }
            // Update home cart display
            try { updateHomeCart(); } catch (e) { /* ignore if not present */ }
        }

        function updateHomeCart() {
            const homeCartSection = document.getElementById('home-cart-section');
            const homeCartItems = document.getElementById('home-cart-items');
            const homeCartTotal = document.getElementById('home-cart-total');
            if (!homeCartSection || !homeCartItems || !homeCartTotal) return;
            if (cart.length === 0) {
                homeCartItems.innerHTML = '<p>ADDED PRODUCTS TO CHECK OUT</p>';
                homeCartTotal.textContent = 'Total: ₹0.00';
                return;
            }
            let total = 0;
            const homeCartHTML = cart.map(item => {
                const subtotal = item.price * item.quantity;
                total += subtotal;
                return `
                    <div class="cart-item">
                        <img src="${item.image}" alt="${item.name}" onerror="this.src='data:image/svg+xml,%3Csvg width=%22250%22 height=%22200%22 xmlns=%22http://www.w3.org/2000/svg%22%3E%3Crect width=%22250%22 height=%22200%22 fill=%22%23ccc%22/%3E%3Ctext x=%22125%22 y=%22100%22 fill=%22%23fff%22 text-anchor=%22middle%22 dy=%220.35em%22 font-size=%2214%22%3ENo Image%3C/text%3E%3C/svg%3E'">
                        <div class="cart-item-info">
                            <h4>${item.name}</h4>
                            <p>₹${item.price.toFixed(2)} x ${item.quantity}</p>
                            <p>Subtotal: ₹${subtotal.toFixed(2)}</p>
                        </div>
                    </div>
                `;
            }).join('');
            homeCartItems.innerHTML = homeCartHTML;
            homeCartTotal.textContent = `Total: ₹${total.toFixed(2)}`;
        }

        function toggleHomeCart() {
            const homeCartSection = document.getElementById('home-cart-section');
            if (cart.length === 0) {
                alert('Your cart is empty.');
                return;
            }
            if (homeCartSection.classList.contains('hidden')) {
                homeCartSection.classList.remove('hidden');
            } else {
                homeCartSection.classList.add('hidden');
            }
        }

        function removeFromCart(productId) {
            cart = cart.filter(item => item.id !== productId);
            updateCart();
            updateCartCount();
            saveCart();
        }

        function increaseQuantity(productId) {
            const item = cart.find(item => item.id === productId);
            if (item) {
                item.quantity += 1;
                updateCart();
                updateCartCount();
                saveCart();
            }
        }

function decreaseQuantity(productId) {
    const item = cart.find(item => item.id === productId);
    if (!item || item.quantity <= 0) return;
    if (item.quantity > 1) {
        item.quantity -= 1;
    } else {
        removeFromCart(productId);
    }
    updateCart();
    updateCartCount();
    saveCart();
}

        function updateCartCount() {
            const count = cart.reduce((total, item) => total + item.quantity, 0);
            const total = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
            document.getElementById('cart-count').textContent = `${count} - ₹${total.toFixed(2)}`;
        }

        function saveCart() {
            localStorage.setItem('cart', JSON.stringify(cart));
        }

        function loadCart() {
            cart = JSON.parse(localStorage.getItem('cart')) || [];
            updateCart();
        }

        function toggleCart() {
            const cartEl = document.getElementById('cart');
            const toggle = document.getElementById('cart-toggle');
            if (!cartEl) return;
            cartEl.classList.toggle('open');
            const isOpen = cartEl.classList.contains('open');
            if (toggle) toggle.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
            // When opening, move focus to the cart for keyboard users
            if (isOpen) {
                cartEl.focus();
            }
            // Set background inert/hidden from assistive tech when cart is open
            setBackgroundInert(isOpen);
        }

        // Set aria-hidden on main page regions to make overlays modal-like
        function setBackgroundInert(inert) {
            const regions = [document.querySelector('header'), document.querySelector('main'), document.querySelector('footer')];
            regions.forEach(el => {
                if (!el) return;
                // If browser supports the inert attribute (or polyfill is loaded), use it
                try {
                    if ('inert' in el) {
                        el.inert = inert;
                    }
                } catch (e) {
                    // ignore and fallback to aria-hidden
                }

                // Always keep aria-hidden in sync as a conservative fallback
                if (inert) {
                    el.setAttribute('aria-hidden', 'true');
                } else {
                    el.removeAttribute('aria-hidden');
                }
            });
        }

        // Search functionality
        function searchProducts() {
            const searchInputEl = document.getElementById('search-input');
            const query = (searchInputEl && searchInputEl.value) ? searchInputEl.value.toLowerCase() : '';
            const filteredProducts = products.filter(product =>
                product.name.toLowerCase().includes(query) ||
                product.description.toLowerCase().includes(query) ||
                product.category.toLowerCase().includes(query)
            );

            const productsContainer = document.getElementById('all-products');
            if (productsContainer) productsContainer.innerHTML = filteredProducts.map(product => createProductCard(product)).join('');

            // Show products page if not already shown
            const productsPage = document.getElementById('products');
            if (productsPage && !productsPage.classList.contains('active')) {
                showPage('products');
            }
        }

        // Filter functionality
        function applyFilters() {
            let filteredProducts = [...products];

            const categoryFilter = document.getElementById('category-filter').value;
            const brandFilter = document.getElementById('brand-filter').value;
            const priceFilter = document.getElementById('price-filter').value;
            const sortFilter = document.getElementById('sort-filter').value;

            if (categoryFilter) {
                filteredProducts = filteredProducts.filter(p => p.category === categoryFilter);
            }

            if (brandFilter) {
                filteredProducts = filteredProducts.filter(p => p.brand === brandFilter);
            }

            if (priceFilter) {
                // support ranges like "0-4150" and open-ended "16600+"
                if (priceFilter.includes('+')) {
                    const min = parseFloat(priceFilter.replace('+', '')) || 0;
                    filteredProducts = filteredProducts.filter(p => p.price >= min);
                } else if (priceFilter.includes('-')) {
                    const parts = priceFilter.split('-').map(v => parseFloat(v));
                    const min = parts[0] || 0;
                    const max = parts[1] || Infinity;
                    filteredProducts = filteredProducts.filter(p => p.price >= min && p.price <= max);
                }
            }

            // Sort
            filteredProducts.sort((a, b) => {
                switch (sortFilter) {
                    case 'price-low':
                        return a.price - b.price;
                    case 'price-high':
                        return b.price - a.price;
                    case 'rating':
                        return b.rating - a.rating;
                    default:
                        return a.name.localeCompare(b.name);
                }
            });

            const productsContainer = document.getElementById('all-products');
            productsContainer.innerHTML = filteredProducts.map(product => createProductCard(product)).join('');
        }

        function filterByCategory(category) {
            document.getElementById('category-filter').value = category;
            showPage('products');
            applyFilters();
        }

        // Authentication
        async function handleLogin(e) {
            e.preventDefault();
            const phoneEl = document.getElementById('login-phone');
            const otpEl = document.getElementById('login-otp');
            if (!phoneEl || !otpEl) return;
            const loginSpinner = document.getElementById('login-spinner');
            if (loginSpinner) loginSpinner.classList.remove('hidden');
            const phone = phoneEl.value.trim();
            const otp = otpEl.value.trim();

            try {
                const response = await fetch('http://localhost:3000/api/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ phone, otp })
                });
                const data = await response.json();
                if (response.ok) {
                    currentUser = data.user;
                    localStorage.setItem('user', JSON.stringify(currentUser));
                    alert('Login successful!');
                    showPage('home');
                    checkLoginStatus();
                    // Clear form
                    clearLoginForm();
                } else {
                    alert(data.error || 'Login failed.');
                }
            } catch (error) {
                alert('Network error. Please try again.');
            }
            if (loginSpinner) loginSpinner.classList.add('hidden');
        }

        function sendLoginOTP() {
            const phone = document.getElementById('login-phone').value.trim();
            if (!phone) {
                alert('Please enter a valid phone number.');
                return;
            }
            const sendOtpBtn = document.getElementById('login-send-otp-btn');
            if (sendOtpBtn) sendOtpBtn.disabled = true;
            fetch('http://localhost:3000/api/login/send-otp', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ phone })
            })
            .then(response => response.json())
            .then(data => {
                if (response.ok) {
                    alert(data.message || 'OTP sent successfully');
                    document.getElementById('login-otp-group').classList.remove('hidden');
                    if (sendOtpBtn) sendOtpBtn.textContent = 'Resend OTP';
                } else {
                    alert(data.error || 'Error sending OTP');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Network error. Please try again.');
            })
            .finally(() => {
                if (sendOtpBtn) sendOtpBtn.disabled = false;
            });
        }

        function clearLoginForm() {
    document.getElementById('login-phone').value = '';
    document.getElementById('login-otp').value = '';
    const otpGroup = document.getElementById('login-otp-group');
    if (otpGroup) otpGroup.classList.add('hidden');
    const sendOtpBtn = document.getElementById('login-send-otp-btn');
    if (sendOtpBtn) sendOtpBtn.textContent = 'Send OTP';
}

        function handleRegister(e) {
            e.preventDefault();
            const nameEl = document.getElementById('register-name');
            const emailEl = document.getElementById('register-email');
            const passwordEl = document.getElementById('register-password');
            if (!nameEl || !emailEl || !passwordEl) return;
            const registerSpinner = document.getElementById('register-spinner');
            if (registerSpinner) registerSpinner.classList.remove('hidden');
            const name = nameEl.value.trim();
            const email = emailEl.value.trim().toLowerCase();
            const password = passwordEl.value;
            const phone = (document.getElementById('register-phone') || {}).value || '';
            const dob = (document.getElementById('register-dob') || {}).value || '';
            const address = (document.getElementById('register-address') || {}).value || '';
            const bio = (document.getElementById('register-bio') || {}).value || '';
            const roleEl = document.querySelector('input[name="role"]:checked');
            const role = roleEl ? roleEl.value : '';

            if (name && email && password && role) {
                // Load existing users and prevent duplicate emails
                const users = JSON.parse(localStorage.getItem('users')) || [];
                const exists = users.some(u => u.email === email);
                if (exists) {
                    alert('An account with this email already exists. Please login.');
                    document.getElementById('register-spinner').classList.add('hidden');
                    return;
                }

                const newUser = { id: Date.now(), name, email, password, phone, dob, address, bio, role };
                users.push(newUser);
                localStorage.setItem('users', JSON.stringify(users));

                // Set the current user without storing the password in the public session
                currentUser = { id: newUser.id, name, email, phone, dob, address, bio, role };
                localStorage.setItem('user', JSON.stringify(currentUser));

                alert('Registration successful!');
                showPage('home');
                checkLoginStatus();

                // Clear form fields
                nameEl.value = '';
                emailEl.value = '';
                passwordEl.value = '';
            } else {
                alert('Please fill in all required fields.');
            }
            if (registerSpinner) registerSpinner.classList.add('hidden');
        }

        function checkLoginStatus() {
            currentUser = JSON.parse(localStorage.getItem('user'));
            const profileInfo = document.getElementById('user-info');
            const loginLink = document.querySelector('nav a[href*="login"]');
            if (currentUser) {
                profileInfo.innerHTML = `
                    <p><strong>Name:</strong> ${currentUser.name}</p>
                    <p><strong>Email:</strong> ${currentUser.email}</p>
                `;
                if (loginLink) {
                    loginLink.textContent = 'Logout';
                    loginLink.setAttribute('onclick', 'logout(); return false;');
                }
            } else {
                profileInfo.textContent = 'Please login to view your profile.';
                if (loginLink) {
                    loginLink.textContent = 'Login';
                    loginLink.setAttribute('onclick', "showPage('login'); return false;");
                }
            }
        }

        function loadProfile() {
            currentUser = JSON.parse(localStorage.getItem('user'));
            if (currentUser) {
                document.getElementById('profile-name').textContent = currentUser.name;
                document.getElementById('profile-photo').src = currentUser.photo || 'https://via.placeholder.com/150/8b4513/ffffff?text=User';
                document.getElementById('profile-email').textContent = currentUser.email;
                document.getElementById('profile-phone').textContent = currentUser.phone || 'Not provided';
                document.getElementById('profile-dob').textContent = currentUser.dob || 'Not provided';
                document.getElementById('profile-address').textContent = currentUser.address || 'Not provided';
                document.getElementById('profile-bio').textContent = currentUser.bio || 'No bio available';
                document.getElementById('profile-details').classList.remove('hidden');

                // Show farmer-specific sections
                if (currentUser.role === 'Farmer') {
                    document.getElementById('product-catalogs-card').style.display = 'block';
                    document.getElementById('availability-calendar-card').style.display = 'block';
                    loadFarmerProducts();
                    renderCalendar();
                } else {
                    document.getElementById('product-catalogs-card').style.display = 'none';
                    document.getElementById('availability-calendar-card').style.display = 'none';
                }
            } else {
                document.getElementById('profile-name').textContent = 'Please login to view your profile.';
                document.getElementById('profile-details').classList.add('hidden');
                document.getElementById('product-catalogs-card').style.display = 'none';
                document.getElementById('availability-calendar-card').style.display = 'none';
            }
        }

        function toggleEditMode() {
            const details = document.getElementById('profile-details');
            const isEditing = details.classList.contains('editing');
            if (isEditing) {
                saveProfile();
            } else {
                enterEditMode();
            }
        }

        function enterEditMode() {
            const details = document.getElementById('profile-details');
            details.classList.add('editing');
            const items = details.querySelectorAll('.detail-value');
            items.forEach(item => {
                const id = item.id;
                const value = item.textContent === 'Not provided' || item.textContent === 'No bio available' ? '' : item.textContent;
                if (id === 'profile-photo') {
                    item.innerHTML = `<input type="file" id="${id}-input" accept="image/*"> <button type="button" class="btn btn-danger small" onclick="deletePhoto()" aria-label="Delete photo">Delete Photo</button>`;
                } else if (id === 'profile-dob') {
                    item.innerHTML = `<div class="input-row"><input type="date" id="${id}-input" value="${value}"> <button type="button" class="btn btn-danger small" onclick="clearField('${id}-input')" aria-label="Delete date">Delete</button></div>`;
                } else if (id === 'profile-bio') {
                    item.innerHTML = `<div class="input-row"><textarea id="${id}-input" rows="3">${value}</textarea> <button type="button" class="btn btn-danger small" onclick="clearField('${id}-input')" aria-label="Delete bio">Delete</button></div>`;
                } else {
                    item.innerHTML = `<div class="input-row"><input type="text" id="${id}-input" value="${value}"> <button type="button" class="btn btn-danger small" onclick="clearField('${id}-input')" aria-label="Delete field">Delete</button></div>`;
                }
            });
            const editBtn = document.getElementById('edit-profile-btn');
            editBtn.textContent = 'Save';
        }

        function clearField(inputId) {
            document.getElementById(inputId).value = '';
        }

        function deletePhoto() {
            deletePhotoFlag = true;
            alert('Photo will be deleted upon saving.');
        }

        function saveProfile() {
            const inputs = document.querySelectorAll('#profile-details input, #profile-details textarea');
            const updates = {};
            let fileInput = null;
            inputs.forEach(input => {
                const id = input.id.replace('-input', '');
                if (input.type === 'file') {
                    fileInput = input;
                } else {
                    updates[id.replace('profile-', '')] = input.value;
                }
            });
            if (deletePhotoFlag) {
                updates['photo'] = null;
                deletePhotoFlag = false;
            }
            const reader = new FileReader();
            reader.onload = function(e) {
                updates['photo'] = e.target.result;
                currentUser = { ...currentUser, ...updates };
                localStorage.setItem('user', JSON.stringify(currentUser));
                loadProfile();
                const details = document.getElementById('profile-details');
                details.classList.remove('editing');
                const editBtn = document.getElementById('edit-profile-btn');
                editBtn.textContent = 'Edit Profile';
            };
            if (fileInput && fileInput.files[0]) {
                const file = fileInput.files[0];
                reader.readAsDataURL(file);
            } else {
                currentUser = { ...currentUser, ...updates };
                localStorage.setItem('user', JSON.stringify(currentUser));
                loadProfile();
                const details = document.getElementById('profile-details');
                details.classList.remove('editing');
                const editBtn = document.getElementById('edit-profile-btn');
                editBtn.textContent = 'Edit Profile';
            }
        }

        function logout() {
            localStorage.removeItem('user');
            currentUser = null;
            showPage('home');
            checkLoginStatus();
        }

        // Checkout
        function updateCheckoutSummary() {
            const checkoutItemsContainer = document.getElementById('checkout-items');
            const subtotalElement = document.getElementById('subtotal');
            const taxElement = document.getElementById('tax');
            const shippingChargeElement = document.getElementById('shipping-charge');
            const discountElement = document.getElementById('discount');
            const checkoutTotalElement = document.getElementById('checkout-total');

            let totalSubtotal = 0;
            let totalGST = 0;
            const shipping = 50.00;
            const discount = 0.00;

            const checkoutHTML = cart.map(item => {
                const subtotal = item.price * item.quantity;
                const gst = subtotal * 0.18;
                totalSubtotal += subtotal;
                totalGST += gst;
                return `
                    <div class="cart-item">
                        <img src="${item.image}" alt="${item.name}" onerror="this.src='data:image/svg+xml,%3Csvg width=%22250%22 height=%22200%22 xmlns=%22http://www.w3.org/2000/svg%22%3E%3Crect width=%22250%22 height=%22200%22 fill=%22%23ccc%22/%3E%3Ctext x=%22125%22 y=%22100%22 fill=%22%23fff%22 text-anchor=%22middle%22 dy=%220.35em%22 font-size=%2214%22%3ENo Image%3C/text%3E%3C/svg%3E'">
                        <div class="cart-item-info">
                            <h4>${item.name}</h4>
                            <p>₹${item.price.toFixed(2)} x ${item.quantity}</p>
                            <p>Subtotal: ₹${subtotal.toFixed(2)}</p>
                            <p>GST (18%): ₹${gst.toFixed(2)}</p>
                        </div>
                    </div>
                `;
            }).join('');

            checkoutItemsContainer.innerHTML = checkoutHTML;
            if (subtotalElement) subtotalElement.textContent = `₹${totalSubtotal.toFixed(2)}`;
            if (taxElement) taxElement.textContent = `₹${totalGST.toFixed(2)}`;
            if (shippingChargeElement) shippingChargeElement.textContent = `₹${shipping.toFixed(2)}`;
            if (discountElement) discountElement.textContent = `-₹${discount.toFixed(2)}`;
            const grandTotal = totalSubtotal + totalGST + shipping - discount;
            if (checkoutTotalElement) checkoutTotalElement.textContent = `₹${grandTotal.toFixed(2)}`;
        }

        function handleCheckout(e) {
            e.preventDefault();

            if (cart.length === 0) {
                alert('Your cart is empty.');
                return;
            }

            // Get shipping information
            const shippingName = document.getElementById('shipping-name').value.trim();
            const shippingAddress = document.getElementById('shipping-address').value.trim();
            const shippingCity = document.getElementById('shipping-city').value.trim();
            const shippingZip = document.getElementById('shipping-zip').value.trim();
            const shippingMobile = document.getElementById('shipping-mobile').value.trim();

            // Get payment method
            let paymentMethod = '';
            const paymentRadios = document.querySelectorAll('input[name="payment-method"]:checked');
            if (paymentRadios.length > 0) {
                paymentMethod = paymentRadios[0].value;
            }

            // Mock order placement
            const order = {
                id: Date.now(),
                user: currentUser || null,
                items: cart,
                total: cart.reduce((sum, item) => sum + item.price * item.quantity, 0),
                date: new Date().toISOString(),
                shipping: {
                    name: shippingName,
                    address: shippingAddress,
                    city: shippingCity,
                    zip: shippingZip,
                    mobile: shippingMobile
                },
                paymentMethod: paymentMethod
            };

            // Save order to localStorage (mock order history)
            const orders = JSON.parse(localStorage.getItem('orders')) || [];
            orders.push(order);
            localStorage.setItem('orders', JSON.stringify(orders));

            // Clear cart
            cart = [];
            saveCart();
            updateCart();
            updateCartCount();

            alert('Order placed successfully!');
            showPage('profile');
            loadOrderHistory();
        }

        // Order history
        function loadOrderHistory() {
            const orders = JSON.parse(localStorage.getItem('orders')) || [];
            const orderHistoryContainer = document.getElementById('order-history');

            if (orders.length === 0) {
                orderHistoryContainer.innerHTML = '<p>No orders yet.</p>';
                return;
            }

            orderHistoryContainer.innerHTML = orders.map(order => `
                <div class="order">
                    <div class="order-info">
                        <h4>Order #${order.id}</h4>
                        <p>Date: ${new Date(order.date).toLocaleDateString()}</p>
                        <p>Total: ₹${order.total.toFixed(2)}</p>
                    <button class="btn btn-secondary" onclick="toggleOrderDetails(${order.id})" aria-label="Show details for order ${order.id}">Show Details</button>
                    </div>
                    <div class="order-items hidden" id="order-items-${order.id}">
                        ${order.items.map(item => `
                            <div class="order-item">
                            <img src="${item.image}" alt="${item.name}" class="order-item-img" onerror="this.src='data:image/svg+xml,%3Csvg width=%2250%22 height=%2250%22 xmlns=%22http://www.w3.org/2000/svg%22%3E%3Crect width=%2250%22 height=%2250%22 fill=%22%23ccc%22/%3E%3Ctext x=%2225%22 y=%2225%22 fill=%22%23fff%22 text-anchor=%22middle%22 dy=%220.35em%22 font-size=%2210%22%3ENo Image%3C/text%3E%3C/svg%3E'">
                    <div class="order-item-details">
                        <h5>${item.name}</h5>
                        <p>Description: ${item.description}</p>
                        <p>Category: ${item.category}</p>
                        <p>Brand: ${item.brand}</p>
                        <p>₹${item.price.toFixed(2)} x ${item.quantity}</p>
                        <p>Subtotal: ₹${(item.price * item.quantity).toFixed(2)}</p>
                        <button class="cancel-btn" onclick="openCancelProductModal(${order.id}, ${item.id}, '${item.name}')" aria-label="Cancel ${item.name}">Cancel Product</button>
                    </div>
                            </div>
                        `).join('')}
                    </div>
                    <button class="cancel-btn" onclick="openCancelModal(${order.id})" aria-label="Cancel order ${order.id}">Cancel Order</button>
                </div>
            `).join('');
        }

        function toggleOrderDetails(orderId) {
                    const details = document.getElementById(`order-items-${orderId}`);
                    if (!details) return;
                    details.classList.toggle('hidden');
        }

        // Fill shipping info in checkout
        function fillShippingInfo() {
            if (currentUser) {
                const nameInput = document.getElementById('shipping-name');
                const addressInput = document.getElementById('shipping-address');
                if (nameInput) nameInput.value = currentUser.name || '';
                if (addressInput) addressInput.value = currentUser.address || '';
                // Leave city and zip empty for user to fill
            }
        }

        // Cancel order modal functions
        let orderToCancel = null;

        function openCancelModal(orderId) {
            orderToCancel = orderId;
            const modal = document.getElementById('cancel-modal');
            if (modal) {
                modal.style.display = 'flex';
                setBackgroundInert(true);
                // focus first focusable element in modal
                const focusable = modal.querySelectorAll('button, [tabindex], select, input, textarea');
                if (focusable.length) focusable[0].focus();
            }
        }

        function closeCancelModal() {
            const modal = document.getElementById('cancel-modal');
            if (modal) modal.style.display = 'none';
            orderToCancel = null;
            const reasonEl = document.getElementById('cancel-reason');
            if (reasonEl) reasonEl.value = '';
            setBackgroundInert(false);
            // restore focus to cart toggle if present
            const toggle = document.getElementById('cart-toggle');
            if (toggle) toggle.focus();
        }

        function confirmCancelOrder() {
            if (!orderToCancel) return;
            const reason = document.getElementById('cancel-reason').value;
            if (!reason) {
                alert('Please select a reason for cancellation.');
                return;
            }
            // Remove order from localStorage
            const orders = JSON.parse(localStorage.getItem('orders')) || [];
            const updatedOrders = orders.filter(order => order.id !== orderToCancel);
            localStorage.setItem('orders', JSON.stringify(updatedOrders));
            alert('Order cancelled successfully.');
            closeCancelModal();
            loadOrderHistory(); // Reload order history to reflect changes
        }

        // Cancel product modal functions
        let productToCancel = null;
        let orderIdForProductCancel = null;

        function openCancelProductModal(orderId, productId, productName) {
            orderIdForProductCancel = orderId;
            productToCancel = productId;
            const modal = document.getElementById('cancel-product-modal');
            const productNameSpan = document.getElementById('cancel-product-name');
            if (modal && productNameSpan) {
                productNameSpan.textContent = productName;
                modal.style.display = 'flex';
                setBackgroundInert(true);
                // focus first focusable element in modal
                const focusable = modal.querySelectorAll('button, [tabindex], select, input, textarea');
                if (focusable.length) focusable[0].focus();
            }
        }

        function closeCancelProductModal() {
            const modal = document.getElementById('cancel-product-modal');
            if (modal) modal.style.display = 'none';
            productToCancel = null;
            orderIdForProductCancel = null;
            const reasonEl = document.getElementById('cancel-product-reason');
            if (reasonEl) reasonEl.value = '';
            setBackgroundInert(false);
            // restore focus to cart toggle if present
            const toggle = document.getElementById('cart-toggle');
            if (toggle) toggle.focus();
        }

        function confirmCancelProduct() {
            if (!productToCancel || !orderIdForProductCancel) return;
            const reason = document.getElementById('cancel-product-reason').value;
            if (!reason) {
                alert('Please select a reason for cancellation.');
                return;
            }
            // Remove product from order
            const orders = JSON.parse(localStorage.getItem('orders')) || [];
            const orderIndex = orders.findIndex(order => order.id === orderIdForProductCancel);
            if (orderIndex === -1) return;
            const order = orders[orderIndex];
            order.items = order.items.filter(item => item.id !== productToCancel);
            // If no items left, remove the entire order
            if (order.items.length === 0) {
                orders.splice(orderIndex, 1);
            } else {
                // Recalculate total
                order.total = order.items.reduce((sum, item) => sum + item.price * item.quantity, 0);
            }
            localStorage.setItem('orders', JSON.stringify(orders));
            alert('Product cancelled successfully.');
            closeCancelProductModal();
            loadOrderHistory(); // Reload order history to reflect changes
        }

        // Add Product Functionality
        function handleProductsClick() {
            if (!currentUser) {
                alert('Please login to add products.');
                showPage('login');
                return;
            }
            if (currentUser.role !== 'Farmer') {
                alert('Only farmers can add products.');
                return;
            }
            openAddProductModal();
        }

        function openAddProductModal() {
            const modal = document.getElementById('add-product-modal');
            modal.style.display = 'flex';
            setBackgroundInert(true);
            const firstInput = modal.querySelector('input');
            if (firstInput) firstInput.focus();
        }

        function closeAddProductModal() {
            const modal = document.getElementById('add-product-modal');
            modal.style.display = 'none';
            setBackgroundInert(false);
            document.getElementById('add-product-form').reset();
        }

        function handleAddProduct(e) {
            e.preventDefault();
            const name = document.getElementById('product-name').value.trim();
            const description = document.getElementById('product-description').value.trim();
            const price = parseFloat(document.getElementById('product-price').value);
            const category = document.getElementById('product-category').value;
            const quantity = parseInt(document.getElementById('product-quantity').value);
            const image = document.getElementById('product-image').value.trim();

            if (!name || !description || isNaN(price) || price <= 0 || !category || isNaN(quantity) || quantity <= 0) {
                alert('Please fill all required fields with valid values.');
                return;
            }

            const newProduct = {
                id: Date.now(),
                name,
                category,
                brand: currentUser.name,
                price,
                description,
                image: image || 'https://via.placeholder.com/250x200?text=No+Image',
                rating: 0,
                reviews: []
            };

            products.push(newProduct);
            localStorage.setItem('products', JSON.stringify(products));
            loadProducts();
            closeAddProductModal();
            alert('Product added successfully!');
        }

        function sendOTP() {
            const mobileInput = document.getElementById('shipping-mobile');
            const mobile = mobileInput.value.trim();
            const otpDisplay = document.getElementById('otp-display');
            const sendOtpBtn = document.getElementById('send-otp-btn');
            const otpGroup = document.getElementById('otp-group');

            // Validate mobile number (10 digits)
            if (!/^\d{10}$/.test(mobile)) {
                otpDisplay.textContent = 'Please enter a valid 10-digit mobile number.';
                otpDisplay.style.color = 'red';
                return;
            }

            // Generate 6-digit OTP
            generatedOTP = Math.floor(100000 + Math.random() * 900000).toString();
            otpSent = true;
            console.log('Generated OTP:', generatedOTP);
            // Display success message
            otpDisplay.textContent = 'OTP sent to your mobile number.';
            otpDisplay.style.color = 'green';
            // Show OTP input group
            otpGroup.classList.remove('hidden');



            // Change button text to Resend OTP
            sendOtpBtn.textContent = 'Resend OTP';
            sendOtpBtn.onclick = function() { resendOTP(); };

            // In a real app, send OTP via SMS API here
            console.log('Generated OTP:', generatedOTP); // For testing purposes
        }

        function resendOTP() {
            if (!otpSent) {
                sendOTP();
                return;
            }
            // Generate new OTP
            generatedOTP = Math.floor(100000 + Math.random() * 900000).toString();
            // Update the displayed OTP in the read-only field
            document.getElementById('generated-otp').value = generatedOTP;
            const otpDisplay = document.getElementById('otp-display');
            otpDisplay.textContent = 'New OTP sent to your mobile number.';
            otpDisplay.style.color = 'green';
            console.log('Resent OTP:', generatedOTP); // For testing purposes
        }

        function verifyOTP() {
            const otpInput = document.getElementById('otp-input');
            const enteredOTP = otpInput.value.trim();
            const otpDisplay = document.getElementById('otp-display');
            const otpGroup = document.getElementById('otp-group');
            const sendOtpBtn = document.getElementById('send-otp-btn');

            if (!otpSent) {
                otpDisplay.textContent = 'Please send OTP first.';
                otpDisplay.style.color = 'red';
                return;
            }

            if (enteredOTP === generatedOTP) {
                otpVerified = true;
                otpDisplay.textContent = 'OTP is verified Successfully';
                otpDisplay.style.color = 'green';
                otpGroup.classList.add('hidden');
                sendOtpBtn.textContent = 'OTP Verified';
                // Disable resend option after 5 seconds
                setTimeout(() => {
                    sendOtpBtn.disabled = true;
                }, 5000);
            } else {
                otpDisplay.textContent = 'Invalid OTP. Please try again.';
                otpDisplay.style.color = 'red';
            }
        }

        function validateAndPay() {
            const checkoutSpinner = document.getElementById('checkout-spinner');
            if (checkoutSpinner) checkoutSpinner.classList.remove('hidden');

            // Determine selected payment method first
            const upiRadio = document.getElementById('upi-radio');
            const cardRadio = document.getElementById('card-radio');
            const netbankingRadio = document.getElementById('netbanking-radio');
            const walletRadio = document.getElementById('wallet-radio');
            const codRadio = document.getElementById('cod-radio');

            let selectedMethod = null;
            if (upiRadio && upiRadio.checked) selectedMethod = 'upi';
            else if (cardRadio && cardRadio.checked) selectedMethod = 'card';
            else if (netbankingRadio && netbankingRadio.checked) selectedMethod = 'netbanking';
            else if (codRadio && codRadio.checked) selectedMethod = 'cod';
            else if (walletRadio && walletRadio.checked) selectedMethod = 'wallet';

            if (!selectedMethod) {
                alert('Please select a payment method.');
                if (checkoutSpinner) checkoutSpinner.classList.add('hidden');
                return;
            }

            // Require OTP for non-COD payments
            if (selectedMethod !== 'cod' && !otpVerified) {
                alert('Please verify your mobile number with OTP before proceeding with payment.');
                if (checkoutSpinner) checkoutSpinner.classList.add('hidden');
                return;
            }

            if (selectedMethod === 'cod') {
        // Validate shipping information
        const nameEl = document.getElementById('shipping-name');
        const addressEl = document.getElementById('shipping-address');
        const cityEl = document.getElementById('shipping-city');
        const zipEl = document.getElementById('shipping-zip');
        const name = nameEl ? nameEl.value.trim() : '';
        const address = addressEl ? addressEl.value.trim() : '';
        const city = cityEl ? cityEl.value.trim() : '';
        const zip = zipEl ? zipEl.value.trim() : '';

        if (!name || !address || !city || !zip) {
            alert('Please fill in all shipping information fields.');
            if (checkoutSpinner) checkoutSpinner.classList.add('hidden');
            return;
        }

        if (cart.length === 0) {
            alert('Your cart is empty.');
            if (checkoutSpinner) checkoutSpinner.classList.add('hidden');
            return;
        }

                // Place the order (similar to handleCheckout)
                const order = {
                    id: Date.now(),
                    user: currentUser,
                    items: cart,
                    total: cart.reduce((sum, item) => sum + item.price * item.quantity, 0),
                    date: new Date().toISOString(),
                    paymentMethod: 'Cash on Delivery'
                };

                // Save order to localStorage
                const orders = JSON.parse(localStorage.getItem('orders')) || [];
                orders.push(order);
                localStorage.setItem('orders', JSON.stringify(orders));

                // Clear cart
                cart = [];
                saveCart();
                updateCart();
                updateCartCount();

                alert('Order placed successfully with Cash on Delivery! Thank you for shopping.');

                // Redirect to profile page
                showPage('Inventory');
            } else {
                alert('This payment method is not implemented yet. Please select Cash on Delivery.');
            }
            if (checkoutSpinner) checkoutSpinner.classList.add('hidden');
        }

        // Farmers page functions
        function loadFarmers() {
            const farmersList = document.getElementById('farmers-list');
            if (!farmersList) return;
            const users = JSON.parse(localStorage.getItem('users')) || sampleUsers;
            const farmers = users.filter(user => user.role === 'Farmer');
            farmersList.innerHTML = farmers.map(farmer => {
                // Get or generate farmer availability
                const key = 'farmer_availability_' + farmer.id;
                let availability = JSON.parse(localStorage.getItem(key)) || farmer.availability || [];
                if (availability.length === 0) {
                    availability = generateRandomAvailabilityDates(5);
                    localStorage.setItem(key, JSON.stringify(availability));
                }
                return `
                <div class="farmer-profile">
                    <h3>${farmer.name}</h3>
                    <p><strong>Email:</strong> ${farmer.email}</p>
                    <p><strong>Phone:</strong> ${farmer.phone}</p>
                    <p><strong>Address:</strong> ${farmer.address}</p>
                    <p><strong>Bio:</strong> ${farmer.bio}</p>
                    <h4>Products:</h4>
                    <div class="farmer-products">
                        ${products.filter(p => p.farmerId === farmer.id).map(p => {
                            // Format availability dates
                            const formattedAvailability = availability.map(dateStr => {
                                const date = new Date(dateStr);
                                const day = date.toLocaleDateString('en-US', { weekday: 'long' });
                                const month = date.toLocaleDateString('en-US', { month: 'long' });
                                const dayNum = date.getDate();
                                const year = date.getFullYear();
                                return `${month} ${dayNum}, ${year} (${day})`;
                            }).join('<br>');
                            return `
                            <div class="product">
                                <img src="${p.image}" alt="${p.name}" onerror="this.src='data:image/svg+xml,%3Csvg width=%22250%22 height=%22200%22 xmlns=%22http://www.w3.org/2000/svg%22%3E%3Crect width=%22250%22 height=%22200%22 fill=%22%23ccc%22/%3E%3Ctext x=%22125%22 y=%22100%22 fill=%22%23fff%22 text-anchor=%22middle%22 dy=%220.35em%22 font-size=%2214%22%3ENo Image%3C/text%3E%3C/svg%3E'">
                                <div class="product-info">
                                    <h4>${p.name}</h4>
                                    <p style="color: black;"><strong>Available:</strong><br>${formattedAvailability || 'No availability set'}</p>
                                    <p style="color: black;">${p.description}</p>
                                    <p class="price" style="color: black;">₹${p.price.toFixed(2)}</p>
                                </div>
                            </div>
                        `}).join('')}
                    </div>
                </div>
            `}).join('');
        }

        let map;
        function initializeMap() {
            const mapContainer = document.getElementById('map');
            if (!mapContainer) return;
            // Center on India
            const indiaCenter = [20.5937, 78.9629];
            map = L.map('map').setView(indiaCenter, 5);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
            addFarmerMarkers();
        }

        function addFarmerMarkers() {
            const users = JSON.parse(localStorage.getItem('users')) || sampleUsers;
            const farmers = users.filter(user => user.role === 'Farmer');
            farmers.forEach(farmer => {
                const marker = L.marker([farmer.location.lat, farmer.location.lng]).addTo(map);
                const farmerProducts = products.filter(p => p.farmerId === farmer.id);
                const popupContent = `
                    <h4>${farmer.name}</h4>
                    <p>${farmer.bio}</p>
                    <p><strong>Products:</strong></p>
                    <ul>
                        ${farmerProducts.map(p => `<li>${p.name} - ₹${p.price.toFixed(2)}</li>`).join('')}
                    </ul>
                `;
                marker.bindPopup(popupContent);
                // Add 10km delivery zone circle
                L.circle([farmer.location.lat, farmer.location.lng], {
                    color: 'blue',
                    fillColor: 'blue',
                    fillOpacity: 0.1,
                    radius: 10000 // 10km in meters
                }).addTo(map);
            });
        }

        // Availability Calendar Functions
        let selectedDates = [];
        let selectedAvailabilityDate = null;

        function renderCalendar() {
            const calendarContainer = document.getElementById('availability-calendar');
            if (!calendarContainer) return;

            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();

            // Load existing availability for the farmer
            const farmerId = currentUser.id;
            const key = 'farmer_availability_' + farmerId;
            selectedDates = JSON.parse(localStorage.getItem(key)) || [];

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());

            const endDate = new Date(lastDay);
            endDate.setDate(endDate.getDate() + (6 - lastDay.getDay()));

            let html = `<h4>${now.toLocaleString('default', { month: 'long' })} ${year}</h4>`;
            html += '<table class="calendar"><thead><tr>';
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            days.forEach(day => html += `<th>${day}</th>`);
            html += '</tr></thead><tbody>';

            let currentDate = new Date(startDate);
            while (currentDate <= endDate) {
                html += '<tr>';
                for (let i = 0; i < 7; i++) {
                    const dateStr = currentDate.toISOString().split('T')[0];
                    const isCurrentMonth = currentDate.getMonth() === month;
                    const isSelected = selectedDates.includes(dateStr);
                    const isPast = currentDate < new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    const className = isSelected ? 'selected' : '';
                    const disabled = isPast ? 'disabled' : '';
                    html += `<td class="calendar-day ${className}" ${disabled} onclick="toggleDate('${dateStr}')" ${isPast ? '' : `style="cursor: pointer;"`}>${isCurrentMonth ? currentDate.getDate() : ''}</td>`;
                    currentDate.setDate(currentDate.getDate() + 1);
                }
                html += '</tr>';
            }
            html += '</tbody></table>';
            calendarContainer.innerHTML = html;
        }

        function toggleDate(dateStr) {
            const index = selectedDates.indexOf(dateStr);
            if (index > -1) {
                selectedDates.splice(index, 1);
            } else {
                selectedDates.push(dateStr);
            }
            renderCalendar(); // Re-render to update selection
        }

        function saveAvailability() {
            if (!currentUser || currentUser.role !== 'Farmer') {
                alert('Only farmers can save availability.');
                return;
            }
            const farmerId = currentUser.id;
            const key = 'farmer_availability_' + farmerId;
            localStorage.setItem(key, JSON.stringify(selectedDates));
            alert('Availability saved successfully!');
        }

        // Public Availability Calendar Functions
        function renderPublicCalendar() {
            const calendarContainer = document.getElementById('public-availability-calendar');
            if (!calendarContainer) return;

            const year = currentCalendarYear;
            const month = currentCalendarMonth;

            // Collect all available dates from farmers
            const availableDates = new Set();
            const users = JSON.parse(localStorage.getItem('users')) || sampleUsers;
            const farmers = users.filter(user => user.role === 'Farmer');
            farmers.forEach(farmer => {
                const key = 'farmer_availability_' + farmer.id;
                const availability = JSON.parse(localStorage.getItem(key)) || [];
                availability.forEach(date => availableDates.add(date));
            });

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());

            const endDate = new Date(lastDay);
            endDate.setDate(endDate.getDate() + (6 - lastDay.getDay()));

            let html = `<h4>${new Date(year, month).toLocaleString('default', { month: 'long' })} ${year}</h4>`;
            html += '<table class="calendar"><thead><tr>';
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            days.forEach(day => html += `<th>${day}</th>`);
            html += '</tr></thead><tbody>';

            let currentDate = new Date(startDate);
            while (currentDate <= endDate) {
                html += '<tr>';
                for (let i = 0; i < 7; i++) {
                    const dateStr = currentDate.toISOString().split('T')[0];
                    const isCurrentMonth = currentDate.getMonth() === month;
                    const isPast = currentDate < new Date(new Date().getFullYear(), new Date().getMonth(), new Date().getDate());
                    const isAvailable = availableDates.has(dateStr);
                    let className = selectedDate === dateStr ? 'selected' : '';
                    if (isAvailable && !isPast) className += ' available';
                    html += `<td class="calendar-day ${className}" ${isPast ? 'disabled' : ''} onclick="selectPublicDate('${dateStr}')" ${isPast ? '' : `style="cursor: pointer;"`}>${isCurrentMonth ? currentDate.getDate() : ''}</td>`;
                    currentDate.setDate(currentDate.getDate() + 1);
                }
                html += '</tr>';
            }
            html += '</tbody></table>';
            calendarContainer.innerHTML = html;
        }

        function navigateCalendar() {
            currentCalendarMonth = parseInt(document.getElementById('calendar-month').value);
            currentCalendarYear = parseInt(document.getElementById('calendar-year').value);
            renderPublicCalendar();
        }

        function selectPublicDate(dateStr) {
            selectedDate = dateStr;
            renderPublicCalendar(); // Update selection
            loadAvailableProducts(dateStr);
        }

        function loadAvailableProducts(dateStr) {
            const container = document.getElementById('available-products-list');
            if (!container) return;

            const users = JSON.parse(localStorage.getItem('users')) || sampleUsers;
            const farmers = users.filter(user => user.role === 'Farmer');

            const availableFarmers = farmers.filter(farmer => {
                const key = 'farmer_availability_' + farmer.id;
                const availability = JSON.parse(localStorage.getItem(key)) || [];
                return availability.includes(dateStr);
            });

            const availableProducts = products.filter(product => {
                return availableFarmers.some(farmer => farmer.id === product.farmerId);
            });

            if (availableProducts.length === 0) {
                container.innerHTML = '<p style="color: white;">No products available on this date.</p>';
                return;
            }

            container.innerHTML = availableProducts.map(product => `
                <div class="product">
                    <img src="${product.image}" alt="${product.name}" onerror="this.src='data:image/svg+xml,%3Csvg width=%22250%22 height=%22200%22 xmlns=%22http://www.w3.org/2000/svg%22%3E%3Crect width=%22125%22 y=%22100%22 fill=%22%23fff%22 text-anchor=%22middle%22 dy=%220.35em%22 font-size=%2214%22%3ENo Image%3C/text%3E%3C/svg%3E'">
                    <div class="product-info">
                        <h4>${product.name}</h4>
                        <p>${product.description}</p>
                        <p class="price">₹${product.price.toFixed(2)}</p>
                        <p><strong>Farmer:</strong> ${users.find(u => u.id === product.farmerId)?.name || 'Unknown'}</p>
                        <button class="btn" onclick="addToCart(${product.id})" aria-label="Add ${product.name} to cart">Add to Cart</button>
                    </div>
                </div>
            `).join('');
        }
    </script>
</body>
</html>
